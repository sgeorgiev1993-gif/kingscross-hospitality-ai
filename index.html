<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kings Cross Hospitality Intelligence</title>

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --border:rgba(148,163,184,.14);
  --text:#e5e7eb;
  --muted:#9ca3af;

  --accent:#f97316;
  --accent2:#60a5fa;
  --good:#22c55e;
  --warn:#fbbf24;
  --bad:#f87171;

  --glass: rgba(255,255,255,.03);
  --glass2: rgba(255,255,255,.05);
  --shadow: 0 20px 40px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(249,115,22,.22), transparent 60%),
    radial-gradient(900px 500px at 110% 10%, rgba(96,165,250,.14), transparent 50%),
    var(--bg);
  color:var(--text);
}

.wrap{max-width:1200px;margin:auto;padding:16px}
h1{margin:0;font-size:22px;letter-spacing:.2px}
h2{margin:0;font-size:16px}
p{margin:6px 0}
.muted{color:var(--muted);font-size:13px}

.top{
  display:flex;
  align-items:flex-end;
  justify-content:space-between;
  gap:12px;
  margin-bottom:14px;
}
.subline{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center;
}

.badge{
  display:inline-flex;
  align-items:center;
  gap:6px;
  padding:4px 10px;
  border-radius:999px;
  font-size:12px;
  border:1px solid rgba(249,115,22,.25);
  background:rgba(249,115,22,.10);
  color:#ffd7b8;
}

.grid{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:16px;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

/* Cards */
.card{
  background:linear-gradient(180deg, var(--glass2), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
}

/* Dropdown */
.dd{
  position:relative;
  margin-top:10px;
}
.ddBtn{
  width:100%;
  display:flex;
  justify-content:space-between;
  align-items:center;
  gap:10px;
  padding:12px 12px;
  border-radius:14px;
  background:rgba(255,255,255,.03);
  border:1px solid var(--border);
  color:var(--text);
  cursor:pointer;
}
.ddBtn:hover{border-color:rgba(249,115,22,.35); background:rgba(249,115,22,.08)}
.ddBtn .left{
  display:flex; flex-direction:column; gap:2px; text-align:left;
}
.ddBtn .titleRow{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
.ddBtn .sub{color:var(--muted); font-size:12px}

.ddPanel{
  display:none;
  position:absolute;
  z-index:20;
  left:0; right:0;
  margin-top:8px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(10,12,18,.96);
  box-shadow:0 24px 50px rgba(0,0,0,.6);
  overflow:hidden;
}
.dd.open .ddPanel{display:block}

.ddSearch{
  width:100%;
  padding:12px 12px;
  border:0;
  outline:none;
  background:rgba(255,255,255,.04);
  color:var(--text);
  font-size:14px;
  border-bottom:1px solid rgba(148,163,184,.12);
}
.ddSearch::placeholder{color:rgba(156,163,175,.9)}

.ddList{
  max-height:360px;
  overflow:auto;
}
.ddItem{
  padding:10px 12px;
  border-bottom:1px solid rgba(148,163,184,.10);
  cursor:pointer;
}
.ddItem:hover{background:rgba(249,115,22,.10)}
.ddItem strong{display:block}
.ddItem .meta{color:var(--muted); font-size:12px; margin-top:2px}
.ddItem .tag{
  display:inline-block;
  padding:2px 8px;
  border-radius:999px;
  font-size:11px;
  border:1px solid rgba(249,115,22,.22);
  background:rgba(249,115,22,.10);
  color:#ffd7b8;
  margin-left:8px;
}

/* KPIs */
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:10px}
.kpi{
  flex:1 1 160px;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
}
.kpi b{font-size:18px}
.kpi small{color:var(--muted)}

/* Buttons */
.btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
.btn{
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  color:var(--text);
  border-radius:999px;
  padding:8px 12px;
  font-size:13px;
  cursor:pointer;
}
.btn:hover{border-color:rgba(249,115,22,.35); background:rgba(249,115,22,.08)}
.btn.active{border-color:rgba(249,115,22,.55); background:rgba(249,115,22,.14)}
.btn.good{border-color:rgba(34,197,94,.35)}
.btn.warn{border-color:rgba(251,191,36,.35)}
.btn.bad{border-color:rgba(248,113,113,.35)}

/* Alerts / panels */
.panel{
  margin-top:12px;
  padding:12px;
  border-radius:16px;
  border:1px solid rgba(148,163,184,.14);
  background:rgba(255,255,255,.03);
}
.alert{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  font-size:14px;
  border:1px solid rgba(148,163,184,.14);
  background:rgba(255,255,255,.03);
}
.alert.good{border-color:rgba(34,197,94,.25); background:rgba(34,197,94,.08)}
.alert.warn{border-color:rgba(251,191,36,.25); background:rgba(251,191,36,.08)}
.alert.bad{border-color:rgba(248,113,113,.25); background:rgba(248,113,113,.08)}

/* Chart */
.chartWrap{
  margin-top:12px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.02);
  padding:10px;
  position:relative;
}
canvas{width:100%; display:block}

.legend{
  display:flex;
  flex-wrap:wrap;
  gap:14px;
  margin-top:10px;
  font-size:12px;
  color:var(--muted);
}
.legend span{display:inline-flex;align-items:center;gap:8px}
.legend i{display:inline-block;width:12px;height:12px;border-radius:3px}
.legend .l-area i{background:rgba(96,165,250,.9)}
.legend .l-venue i{background:rgba(249,115,22,.95)}
.legend .l-rush i{background:rgba(249,115,22,.12); border:1px dashed rgba(249,115,22,.4)}

.tooltip{
  position:absolute;
  pointer-events:none;
  background:rgba(17,24,39,.96);
  border:1px solid rgba(148,163,184,.25);
  color:var(--text);
  padding:10px;
  border-radius:12px;
  font-size:12px;
  line-height:1.35;
  min-width: 190px;
  box-shadow: 0 18px 35px rgba(0,0,0,.55);
  transform: translate(-50%, -120%);
  opacity:0;
  transition: opacity .08s linear;
  z-index: 30;
}
.tooltip strong{display:block;margin-bottom:4px}

/* Right column sections */
.sectionTitle{
  display:flex;
  align-items:center;
  justify-content:space-between;
  gap:10px;
}
.smallPill{
  font-size:12px;
  padding:3px 10px;
  border-radius:999px;
  border:1px solid rgba(96,165,250,.22);
  background:rgba(96,165,250,.10);
  color:#cfe6ff;
}
</style>
</head>

<body>
<div class="wrap">

  <div class="top">
    <div>
      <h1>Kings Cross Hospitality Intelligence</h1>
      <div class="subline">
        <p class="muted" id="lastUpdated">Loading‚Ä¶</p>
        <span class="badge">üìç Coal Drops Yard focus</span>
      </div>
    </div>
  </div>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <div class="sectionTitle">
        <h2>Venue (live)</h2>
        <span class="smallPill" id="venuesMeta">‚Äî</span>
      </div>

      <!-- Custom dropdown -->
      <div class="dd" id="venueDD">
        <button class="ddBtn" id="ddBtn" type="button">
          <div class="left">
            <div class="titleRow">
              <strong id="ddTitle">Loading venues‚Ä¶</strong>
              <span id="ddTag" style="display:none" class="badge">‚≠ê Morty & Bob‚Äôs</span>
            </div>
            <div class="sub" id="ddSub">‚Äî</div>
          </div>
          <span style="opacity:.8">‚ñæ</span>
        </button>

        <div class="ddPanel" id="ddPanel">
          <input class="ddSearch" id="ddSearch" placeholder="Search places (food, cafes, bars)‚Ä¶" />
          <div class="ddList" id="ddList"></div>
        </div>
      </div>

      <div class="panel">
        <div style="display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap">
          <div>
            <div class="muted">Observed right now</div>
            <div class="muted" id="obsStatus">Not set</div>
          </div>
          <button class="btn" id="clearObsBtn" type="button">Clear</button>
        </div>

        <div class="btnRow" id="obsButtons">
          <button class="btn good" data-obs="quiet" type="button">Quiet</button>
          <button class="btn warn" data-obs="steady" type="button">Steady</button>
          <button class="btn bad"  data-obs="busy" type="button">Busy</button>
        </div>

        <p class="muted" style="margin-top:10px">
          This tunes the forecast locally for the next hours (no pipeline change).
        </p>
      </div>

      <div class="panel">
        <h2 style="margin-bottom:6px">Transport pulse</h2>
        <p id="transportPulse" class="muted">Loading‚Ä¶</p>
      </div>
    </div>

    <!-- RIGHT -->
    <div>
      <div class="card">
        <div class="sectionTitle">
          <h2 id="venueTitle">Area Overview</h2>
          <span class="smallPill" id="confidencePill">‚Äî</span>
        </div>

        <p id="headline" style="font-size:18px;margin-top:6px">Loading‚Ä¶</p>
        <p class="muted" id="subHeadline"></p>

        <div class="kpis">
          <div class="kpi">
            <div class="muted">Now</div>
            <b id="kpiNow">‚Äî</b><br/>
            <small id="kpiNowHint">‚Äî</small>
          </div>
          <div class="kpi">
            <div class="muted">Expected peak</div>
            <b id="kpiPeak">‚Äî</b><br/>
            <small id="kpiPeakHint">‚Äî</small>
          </div>
          <div class="kpi">
            <div class="muted">Today vs yesterday</div>
            <b id="kpiVs">‚Äî</b><br/>
            <small id="kpiVsHint">‚Äî</small>
          </div>
        </div>

        <!-- Chart -->
        <div class="chartWrap">
          <canvas id="venueChart" height="220"></canvas>
          <div id="chartTip" class="tooltip"></div>
          <div class="legend">
            <span class="l-area"><i></i> Area baseline</span>
            <span class="l-venue"><i></i> Venue-adjusted</span>
            <span class="l-rush"><i></i> Rush hour</span>
          </div>
        </div>

        <p id="chartNote" class="muted"></p>

        <!-- Why + What to do -->
        <div class="panel">
          <h2>Why demand changes</h2>
          <ul id="reasons" class="muted" style="margin:8px 0 0; padding-left:18px"></ul>
        </div>

        <div class="panel">
          <h2>What to do now</h2>
          <ul id="actions" class="muted" style="margin:8px 0 0; padding-left:18px"></ul>
        </div>

        <div id="alerts"></div>
      </div>
    </div>

  </div>
</div>

<script>
/* ---------------- Helpers ---------------- */
async function loadJSON(p){
  try{
    const r = await fetch(p,{cache:"no-store"});
    return r.ok ? await r.json() : null;
  }catch{return null;}
}
function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
function fmtTime(iso){
  try{ return new Date(iso).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"}); }
  catch{ return ""; }
}
function heatText(v){
  if(v>=85) return "Very busy";
  if(v>=70) return "Busy";
  if(v>=55) return "Steady";
  return "Quiet";
}
function isMortyBobs(name){
  const s = String(name||"").toLowerCase();
  return s.includes("morty") && s.includes("bob");
}

/* ---------------- State ---------------- */
let dashboard = {};
let history = [];
let forecast = [];
let venues = [];
let activeVenue = null;

/* ---------------- Observed-now calibration ----------------
We store a small calibration delta (in points) per venue id.
It shifts the next-hours forecast in the UI only.
*/
function obsKey(venueId){ return `obs_${venueId||"area"}`; }

function setObserved(venueId, level){
  // map level to target "now score"
  const target = (level==="busy") ? 82 : (level==="steady") ? 60 : 42;
  const predicted = venueNow();
  const delta = clamp(Math.round(target - predicted), -20, 20);

  const payload = {
    level,
    delta,
    at: new Date().toISOString()
  };
  localStorage.setItem(obsKey(venueId), JSON.stringify(payload));
}

function getObserved(venueId){
  try{
    const raw = localStorage.getItem(obsKey(venueId));
    if(!raw) return null;
    const obj = JSON.parse(raw);
    if(!obj || typeof obj.delta!=="number") return null;
    return obj;
  }catch{return null;}
}

function clearObserved(venueId){
  localStorage.removeItem(obsKey(venueId));
}

/* ---------------- Venue logic ---------------- */
/*
We‚Äôre using Google Places "types" list. Instead of forcing restaurant,
we treat everything as "food place" and just use distance + rating + transit reliance.
*/
function calcConfidence(v){
  let c=0.45;

  const rating = Number(v.rating ?? 0);
  const reviews = Number(v.reviews ?? v.user_ratings_total ?? 0);
  const dist = Number(v.distance_km ?? 9);

  if(rating >= 4.2) c += 0.18;
  if(reviews >= 200) c += 0.12;
  else if(reviews >= 60) c += 0.06;

  if(dist < 0.5) c += 0.10;
  else if(dist < 1.2) c += 0.06;

  if(forecast.length >= 8) c += 0.06;
  if(history.length >= 12) c += 0.06;

  return clamp(c, 0.35, 0.95);
}

function venueMultiplier(v){
  if(!v) return 1;

  const tr = Number(v.transit_reliance ?? 0.8); // 0.7‚Äì0.95
  const rating = Number(v.rating ?? 4.2);

  // destination draw: high rating slightly reduces reliance on passing traffic
  const destination = clamp((rating - 4.0) * 0.10, 0, 0.08);

  // map transit reliance to multiplier ~0.85‚Äì1.12
  const m = 0.78 + (tr * 0.35) + destination;
  return clamp(m, 0.75, 1.15);
}

function areaNow(){
  return (history.at(-1)?.busyness ?? forecast[0]?.busyness ?? 55);
}

function venueNow(){
  const base = areaNow();
  if(!activeVenue) return base;

  const m = venueMultiplier(activeVenue);
  let score = Math.round(base * m);

  // apply observed calibration
  const obs = getObserved(activeVenue.id);
  if(obs) score = clamp(score + obs.delta, 0, 100);

  return score;
}

function venuePeak(){
  if(!forecast.length) return null;

  if(!activeVenue){
    const best = forecast.reduce((a,b)=> (b.busyness>a.busyness?b:a), forecast[0]);
    return { time: best.time, score: best.busyness };
  }

  const m = venueMultiplier(activeVenue);
  const obs = getObserved(activeVenue.id);
  const delta = obs?.delta ?? 0;

  let best=null;
  forecast.forEach(f=>{
    const base = Number(f.busyness ?? 55);
    const adj = clamp(Math.round(base*m + delta), 0, 100);
    if(!best || adj>best.score) best = { time: f.time, score: adj, rush_hour: !!f.rush_hour };
  });
  return best;
}

function todayVsYesterday(){
  // compare last 6 points vs previous 6 points (your pipeline is hourly-ish)
  if(history.length < 12) return null;
  const a = history.slice(-6).reduce((s,h)=>s+Number(h.busyness??0),0)/6;
  const b = history.slice(-12,-6).reduce((s,h)=>s+Number(h.busyness??0),0)/6;
  return Math.round(a - b);
}

/* ---------------- Transport impact ---------------- */
function transportImpactText(v){
  const tp = dashboard?.transit_pressure || {};
  const level = tp.level || "Unknown";
  const score = tp.score;

  if(!v) return `Transit pressure: ${level}${score!=null?` (${score}/100)`:``}.`;

  const tr = Number(v.transit_reliance ?? 0.8);
  if(level === "High" && tr >= 0.85) return "High transport impact for this venue (station-dependent footfall).";
  if(level === "High" && tr < 0.85)  return "High disruption, but this venue is more destination-driven.";
  if(level === "Medium" && tr >= 0.85) return "Medium transport impact (watch commuters).";
  if(level === "Medium") return "Medium transport impact.";
  return "Low transport impact.";
}

/* ---------------- Dropdown render ---------------- */
function sortVenuesForCDY(list){
  // Coal Drops Yard focus = closer first (simple)
  return [...list].sort((a,b)=> (Number(a.distance_km??9) - Number(b.distance_km??9)));
}

function setDDSelected(v){
  const title = document.getElementById("ddTitle");
  const sub = document.getElementById("ddSub");
  const tag = document.getElementById("ddTag");

  if(!v){
    title.textContent = "Area Overview";
    sub.textContent = "Select a venue to personalise insights";
    tag.style.display="none";
    return;
  }

  title.textContent = v.name || "Venue";
  const dist = Number(v.distance_km ?? 0).toFixed(2);
  const rating = (v.rating!=null) ? `${Number(v.rating).toFixed(1)}‚òÖ` : "‚Äî";
  const reviews = (v.reviews!=null) ? `${v.reviews} reviews` : (v.user_ratings_total!=null?`${v.user_ratings_total} reviews`:"");
  sub.textContent = `${dist} km ¬∑ ${rating}${reviews?` ¬∑ ${reviews}`:""}`;

  if(isMortyBobs(v.name)){
    tag.style.display="inline-flex";
  }else{
    tag.style.display="none";
  }
}

function renderDropdown(list){
  const meta = document.getElementById("venuesMeta");
  const dd = document.getElementById("venueDD");
  const panel = document.getElementById("ddPanel");
  const search = document.getElementById("ddSearch");
  const items = document.getElementById("ddList");

  meta.textContent = `${list.length} places`;

  function draw(filtered){
    items.innerHTML="";
    if(!filtered.length){
      items.innerHTML = `<div class="ddItem"><strong>No matches</strong><div class="meta">Try another search</div></div>`;
      return;
    }

    filtered.forEach(v=>{
      const d = Number(v.distance_km ?? 9).toFixed(2);
      const r = (v.rating!=null) ? Number(v.rating).toFixed(1) : "‚Äî";
      const conf = Math.round(calcConfidence(v)*100);
      const morty = isMortyBobs(v.name);

      const el = document.createElement("div");
      el.className="ddItem";
      el.innerHTML = `
        <strong>${v.name || "Place"} ${morty?`<span class="tag">‚≠ê Morty & Bob‚Äôs</span>`:""}</strong>
        <div class="meta">${d} km ¬∑ ${r}‚òÖ ¬∑ ${conf}% confidence</div>
      `;
      el.onclick = ()=>{
        activeVenue = v;
        localStorage.setItem("venue_id", v.id || "");
        closeDD();
        setDDSelected(activeVenue);
        updateAll();
      };
      items.appendChild(el);
    });
  }

  function openDD(){
    dd.classList.add("open");
    panel.style.display="block";
    search.value="";
    draw(list);
    setTimeout(()=>search.focus(), 50);
  }
  function closeDD(){
    dd.classList.remove("open");
    panel.style.display="none";
  }

  document.getElementById("ddBtn").onclick = ()=>{
    if(dd.classList.contains("open")) closeDD();
    else openDD();
  };

  search.oninput = ()=>{
    const q = search.value.trim().toLowerCase();
    const filtered = !q ? list : list.filter(v=>{
      const name = String(v.name||"").toLowerCase();
      const types = Array.isArray(v.types)? v.types.join(" ").toLowerCase() : "";
      return name.includes(q) || types.includes(q);
    });
    draw(filtered);
  };

  document.addEventListener("click",(e)=>{
    if(!dd.contains(e.target)) closeDD();
  });

  // initial
  setDDSelected(activeVenue);
  draw(list);
}

/* ---------------- Reasons + actions ---------------- */
function buildReasons(){
  const reasons = document.getElementById("reasons");
  reasons.innerHTML="";

  const w = dashboard?.weather || {};
  const tp = dashboard?.transit_pressure || {};
  const rush = forecast?.some(f=>f.rush_hour) ? true : false;
  const temp = w.temperature_C;

  const obs = activeVenue ? getObserved(activeVenue.id) : null;
  const venueName = activeVenue?.name || "this area";

  const bullets = [];

  // Transport
  if(tp.level){
    if(tp.level === "High") bullets.push(`Transport disruption is high ‚Äî expect footfall distortion near stations and interchanges.`);
    if(tp.level === "Medium") bullets.push(`Transport pressure is medium ‚Äî commuter flow can swing demand quickly.`);
    if(tp.level === "Low") bullets.push(`Transport is calm ‚Äî demand should follow normal local patterns.`);
  }

  // Rush hour
  if(rush) bullets.push(`Rush hour window exists in the next hours ‚Äî peaks tend to form around commuter surges.`);

  // Weather
  if(typeof temp === "number"){
    if(temp <= 4) bullets.push(`Cold weather tends to reduce casual walk-ins (more delivery / fewer stroll-ins).`);
    else if(temp >= 12 && temp <= 20) bullets.push(`Comfortable weather supports higher walk-in conversion.`);
    else bullets.push(`Weather is neutral ‚Äî demand depends more on transport + local movement.`);
  }else{
    bullets.push(`Weather signal missing ‚Äî transport + baseline history drive the model today.`);
  }

  // Venue / distance
  if(activeVenue){
    const d = Number(activeVenue.distance_km ?? 0);
    if(d <= 0.35) bullets.push(`${venueName} is very close to the core footfall corridor ‚Äî more ‚Äúpassing traffic‚Äù sensitivity.`);
    else if(d <= 0.8) bullets.push(`${venueName} is within the main orbit ‚Äî mix of destination + passing traffic.`);
    else bullets.push(`${venueName} is a bit further out ‚Äî more destination-driven and less sensitive to station spikes.`);
  }

  // Observed calibration
  if(obs){
    bullets.push(`Live calibration applied: you marked it as ‚Äú${obs.level}‚Äù (${obs.delta>=0?"+":""}${obs.delta} pts) ‚Äî forecast tuned for the next hours.`);
  }else{
    bullets.push(`Tip: use ‚ÄúObserved now‚Äù during service ‚Äî it tightens the forecast to your reality.`);
  }

  // Add extra optional bullets so you can choose later
  bullets.push(`(Optional) Add event signal later if you want stronger leisure spikes near Coal Drops Yard.`);
  bullets.push(`(Optional) Add per-venue opening hours later for more professional staffing recommendations.`);

  bullets.slice(0,7).forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    reasons.appendChild(li);
  });
}

function buildActions(){
  const actions = document.getElementById("actions");
  actions.innerHTML="";

  const now = venueNow();
  const peak = venuePeak();
  const tp = dashboard?.transit_pressure?.level || "Low";

  const list = [];

  if(now >= 75){
    list.push("Stage a runner + clear pass; keep a tight expo flow (speed beats complexity).");
    list.push("Pre-batch top sellers (coffee / cocktails / fries / burger garnish depending on venue).");
    list.push("Increase front-of-house scanning: queue control + faster order capture.");
  }else if(now >= 60){
    list.push("Prep for a surge: pre-fire popular items 10‚Äì15 min ahead of the peak.");
    list.push("Assign one person to restock & reset (glassware, cutlery, sauces) to prevent micro-breakdowns.");
  }else{
    list.push("Use quiet time to improve conversion: suggestive selling + tighten table turns.");
    list.push("Clean & reset stations; get ahead on prep to protect peak quality.");
  }

  if(peak && peak.score >= 75){
    list.push(`Plan extra hands 30‚Äì45 min before peak (~${fmtTime(peak.time)}).`);
  }else if(peak){
    list.push(`Peak looks moderate (~${fmtTime(peak.time)}). Keep one flexible floater ready.`);
  }

  if(tp === "High") list.push("Transport disruption: expect uneven waves ‚Äî keep staffing flexible, avoid over-prepping perishable items.");
  if(tp === "Medium") list.push("Transport medium: watch commuter pulses ‚Äî adjust pace in short bursts.");

  list.slice(0,6).forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    actions.appendChild(li);
  });
}

/* ---------------- Alerts + confidence ---------------- */
function buildAlerts(){
  const wrap=document.getElementById("alerts");
  wrap.innerHTML="";

  const v = activeVenue;
  const peak = venuePeak();

  if(!v){
    wrap.innerHTML = `<div class="alert good">Pick a venue to get tailored advice and a tuned forecast.</div>`;
    return;
  }

  const conf = calcConfidence(v);
  const confPct = Math.round(conf*100);

  if(conf < 0.65){
    wrap.innerHTML += `<div class="alert warn">Confidence is lower for this venue (${confPct}%). Use this as guidance and trust walk-in signals.</div>`;
  }else{
    wrap.innerHTML += `<div class="alert good">Confidence is solid for this venue (${confPct}%). This is usable for staffing & prep decisions.</div>`;
  }

  if(peak && peak.score >= 80){
    wrap.innerHTML += `<div class="alert bad">Strong peak expected around ${fmtTime(peak.time)}. Prep extra hands 30‚Äì45 min before.</div>`;
  }else if(peak && peak.score >= 65){
    wrap.innerHTML += `<div class="alert warn">Moderate peak expected around ${fmtTime(peak.time)}. Stage sections and watch ticket times.</div>`;
  }else{
    wrap.innerHTML += `<div class="alert good">No major peak expected soon. Keep service smooth and focus on conversion.</div>`;
  }

  const level = dashboard?.transit_pressure?.level || "Low";
  const cls = (level==="High")?"bad":(level==="Medium")?"warn":"good";
  wrap.innerHTML += `<div class="alert ${cls}">${transportImpactText(v)}</div>`;
}

/* ---------------- Chart: Area vs Venue ---------------- */
function drawVenueChart(){
  const c = document.getElementById("venueChart");
  const note = document.getElementById("chartNote");
  const tip  = document.getElementById("chartTip");
  if(!c) return;

  const ctx = c.getContext("2d");
  const w = c.width = c.offsetWidth;
  const h = c.height;

  ctx.clearRect(0,0,w,h);

  if(!forecast || !forecast.length){
    ctx.fillStyle = "rgba(156,163,175,.9)";
    ctx.font = "14px system-ui";
    ctx.fillText("Forecast not available yet (check data/forecast.json)", 12, 30);
    if(note) note.textContent = "";
    return;
  }

  const padTop = 16;
  const padBot = 26;

  const area = forecast.map(f => Number(f.busyness ?? 55));
  const m = activeVenue ? venueMultiplier(activeVenue) : 1;
  const obs = activeVenue ? getObserved(activeVenue.id) : null;
  const delta = obs?.delta ?? 0;

  const venue = area.map(v => clamp(Math.round(v*m + delta), 0, 100));

  const all = [...area, ...venue];
  const yMin = Math.min(...all, 0);
  const yMax = Math.max(...all, 100);

  const xs = forecast.map((_, i) => (i / Math.max(forecast.length - 1, 1)) * w);
  const y = v => padTop + (h - padTop - padBot) * (1 - (v - yMin) / Math.max(yMax - yMin, 1));

  // grid
  ctx.strokeStyle = "rgba(255,255,255,0.06)";
  for(let i=0;i<=4;i++){
    const yy = padTop + (i/4)*(h-padTop-padBot);
    ctx.beginPath(); ctx.moveTo(0,yy); ctx.lineTo(w,yy); ctx.stroke();
  }

  // rush hour shading
  forecast.forEach((f,i)=>{
    if(!f.rush_hour) return;
    const bw = w / Math.max(forecast.length,1);
    ctx.fillStyle="rgba(249,115,22,.12)";
    ctx.fillRect(xs[i]-bw/2, 0, bw, h);
  });

  function drawLine(vals, color, width){
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();
    vals.forEach((v,i)=>{
      if(i===0) ctx.moveTo(xs[i], y(v));
      else ctx.lineTo(xs[i], y(v));
    });
    ctx.stroke();
  }
  function drawDots(vals, color){
    ctx.fillStyle = color;
    vals.forEach((v,i)=>{
      ctx.beginPath();
      ctx.arc(xs[i], y(v), 3, 0, Math.PI*2);
      ctx.fill();
    });
  }

  drawLine(area,  "rgba(96,165,250,.95)", 2);
  drawDots(area, "rgba(96,165,250,.95)");

  drawLine(venue, "rgba(249,115,22,.98)", 2.8);
  drawDots(venue,"rgba(249,115,22,.98)");

  // tooltip
  if(tip){
    c.onmousemove = e=>{
      const r = c.getBoundingClientRect();
      const mx = e.clientX - r.left;

      let idx = 0, best = Infinity;
      xs.forEach((x,i)=>{
        const d = Math.abs(x - mx);
        if(d < best){ best=d; idx=i; }
      });

      const f = forecast[idx];
      const time = fmtTime(f.time);
      const rush = f.rush_hour ? "Rush hour" : "No rush";
      const tp = dashboard?.transit_pressure?.level || "Unknown";
      const cal = obs ? ` ¬∑ Cal ${delta>=0?"+":""}${delta}` : "";

      tip.innerHTML = `
        <strong>${time}</strong>
        Venue: <b>${venue[idx]}/100</b><br>
        Area: ${area[idx]}/100<br>
        <span class="muted">${rush} ¬∑ Transit ${tp}${cal}</span>
      `;
      tip.style.left = xs[idx] + "px";
      tip.style.top  = y(venue[idx]) + "px";
      tip.style.opacity = 1;
    };
    c.onmouseleave = ()=> tip.style.opacity = 0;
  }

  if(note){
    note.textContent = activeVenue
      ? `Venue-adjusted forecast ¬∑ multiplier ${m.toFixed(2)}${obs?` ¬∑ live calibration ${delta>=0?"+":""}${delta}`:""}`
      : `Select a venue to see venue-specific demand`;
  }
}

/* ---------------- UI update ---------------- */
function updateObservedUI(){
  const status = document.getElementById("obsStatus");
  const buttons = document.getElementById("obsButtons").querySelectorAll("button");
  buttons.forEach(b=>b.classList.remove("active"));

  if(!activeVenue){
    status.textContent = "Select a venue first";
    return;
  }

  const obs = getObserved(activeVenue.id);
  if(!obs){
    status.textContent = "Not set";
    return;
  }

  status.textContent = `${obs.level.toUpperCase()} (${obs.delta>=0?"+":""}${obs.delta} pts) ¬∑ ${new Date(obs.at).toLocaleTimeString([], {hour:"2-digit",minute:"2-digit"})}`;
  buttons.forEach(b=>{
    if(b.dataset.obs === obs.level) b.classList.add("active");
  });
}

function updateAll(){
  const v = activeVenue;

  document.getElementById("venueTitle").textContent = v ? v.name : "Area Overview";

  const now = venueNow();
  document.getElementById("headline").textContent = `${heatText(now)} demand right now`;

  const w = dashboard?.weather;
  const temp = (w && w.temperature_C!=null) ? `${Number(w.temperature_C).toFixed(1)}¬∞C` : "‚Äî";
  const cond = (w && w.condition) ? w.condition : "‚Äî";
  const transit = dashboard?.transit_pressure?.level || "‚Äî";
  document.getElementById("subHeadline").textContent =
    `Weather: ${temp} ¬∑ ${cond} ¬∑ Transit: ${transit}`;

  document.getElementById("kpiNow").textContent = `${now}/100`;
  document.getElementById("kpiNowHint").textContent = v ? `Multiplier ${venueMultiplier(v).toFixed(2)}` : "Baseline area";

  const peak = venuePeak();
  document.getElementById("kpiPeak").textContent = peak ? `${peak.score}/100` : "‚Äî";
  document.getElementById("kpiPeakHint").textContent = peak ? `~${fmtTime(peak.time)}` : "‚Äî";

  const diff = todayVsYesterday();
  document.getElementById("kpiVs").textContent = (diff==null) ? "‚Äî" : `${diff>=0?"+":""}${diff}`;
  document.getElementById("kpiVsHint").textContent = (diff==null) ? "Need ‚â•12 points" : "Last 6 vs prev 6";

  // confidence pill
  if(v){
    const conf = Math.round(calcConfidence(v)*100);
    document.getElementById("confidencePill").textContent = `${conf}% confidence`;
  }else{
    document.getElementById("confidencePill").textContent = `Area view`;
  }

  // transport pulse left card
  const tp = dashboard?.transit_pressure || {};
  const drivers = Array.isArray(tp.drivers) ? tp.drivers.join(", ") : "";
  document.getElementById("transportPulse").textContent =
    tp.level ? `Transit pressure: ${tp.level}${tp.score!=null?` (${tp.score}/100)`:``}${drivers?` ¬∑ ${drivers}`:""}` : "Transit pressure unavailable";

  updateObservedUI();
  drawVenueChart();
  buildReasons();
  buildActions();
  buildAlerts();
}

/* ---------------- Init ---------------- */
(async()=>{
  dashboard = await loadJSON("data/kingscross_dashboard.json") || {};
  history   = await loadJSON("data/history/kingscross_history.json") || [];
  forecast  = await loadJSON("data/forecast.json") || [];

  document.getElementById("lastUpdated").textContent =
    dashboard?.timestamp ? "Updated " + new Date(dashboard.timestamp).toLocaleString() : "No timestamp";

  // Use "food" not just restaurants: rely on pipeline‚Äôs venues. (Pipeline currently uses nearbysearch; if you change type to "food", it'll broaden.)
  venues = Array.isArray(dashboard.venues) ? dashboard.venues : [];

  // Sort for Coal Drops Yard focus (simple: closer first)
  venues = sortVenuesForCDY(venues);

  // Pick Morty & Bob‚Äôs if available; else restore saved; else first.
  const saved = localStorage.getItem("venue_id");

  const morty = venues.find(v=>isMortyBobs(v.name));
  if(morty){
    activeVenue = morty;
  }else if(saved){
    activeVenue = venues.find(v=>String(v.id)===String(saved)) || null;
  }
  if(!activeVenue && venues.length) activeVenue = venues[0];

  // Dropdown
  renderDropdown(venues);

  // observed buttons
  document.getElementById("obsButtons").addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-obs]");
    if(!btn || !activeVenue) return;
    setObserved(activeVenue.id, btn.dataset.obs);
    updateAll();
  });

  document.getElementById("clearObsBtn").onclick = ()=>{
    if(!activeVenue) return;
    clearObserved(activeVenue.id);
    updateAll();
  };

  // selected display
  setDDSelected(activeVenue);

  // update main
  updateAll();
})();
</script>
</body>
</html>
