<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kings Cross Hospitality Intelligence</title>

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --border:rgba(148,163,184,.14);
  --text:#e5e7eb;
  --muted:#9ca3af;

  --accent:#f97316;
  --accent2:#60a5fa;
  --good:#22c55e;
  --warn:#fbbf24;
  --bad:#f87171;
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:
    radial-gradient(1200px 600px at 10% -10%, rgba(249,115,22,.25), transparent 60%),
    var(--bg);
  color:var(--text);
}

.wrap{max-width:1200px;margin:auto;padding:18px}
h1{margin:0;font-size:22px}
h2{margin:0;font-size:16px}
p{margin:6px 0}
.muted{color:var(--muted);font-size:13px}

.grid{
  display:grid;
  grid-template-columns: 360px 1fr;
  gap:16px;
}
@media(max-width:900px){
  .grid{grid-template-columns:1fr}
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.45);
}

/* ---------- CUSTOM DROPDOWN ---------- */
.dropdown{
  position:relative;
}
.dropdown input{
  width:100%;
  padding:12px 14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:#121622;
  color:var(--text);
  outline:none;
}
.dropdown-list{
  position:absolute;
  top:48px;
  left:0;
  right:0;
  max-height:320px;
  overflow:auto;
  background:#0f1320;
  border:1px solid var(--border);
  border-radius:14px;
  box-shadow:0 20px 40px rgba(0,0,0,.6);
  z-index:10;
  display:none;
}
.dropdown-item{
  padding:10px 12px;
  cursor:pointer;
  border-bottom:1px solid rgba(255,255,255,.04);
}
.dropdown-item:hover{
  background:rgba(249,115,22,.15);
}
.dropdown-item strong{font-weight:600}
.dropdown-item .meta{
  font-size:12px;
  color:var(--muted);
}
.dropdown-item.tracked{
  background:rgba(249,115,22,.18);
  border-left:4px solid var(--accent);
}
.dropdown-item:last-child{border-bottom:none}

/* KPIs */
.kpis{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px}
.kpi{
  flex:1 1 140px;
  padding:10px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
}
.kpi b{font-size:18px}

/* Alerts */
.alert{
  margin-top:10px;
  padding:12px;
  border-radius:14px;
  font-size:14px;
}
.alert.good{background:rgba(34,197,94,.12);border:1px solid rgba(34,197,94,.3)}
.alert.warn{background:rgba(251,191,36,.12);border:1px solid rgba(251,191,36,.3)}
.alert.bad{background:rgba(248,113,113,.12);border:1px solid rgba(248,113,113,.3)}

.chartWrap{
  margin-top:14px;
  border-radius:14px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.02);
  padding:10px;
}
canvas{width:100%;display:block}

</style>
</head>

<body>
<div class="wrap">
  <h1>Kings Cross Hospitality Intelligence</h1>
  <p class="muted" id="lastUpdated"></p>

  <div class="grid">

    <!-- LEFT -->
    <div class="card">
      <h2>Venue selector</h2>
      <p class="muted">Coal Drops Yard · live food & hospitality</p>

      <div class="dropdown">
        <input id="venueSearch" placeholder="Search food venues (e.g. Morty & Bob’s)…">
        <div id="venueDropdown" class="dropdown-list"></div>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="card">
      <h2 id="venueTitle">Coal Drops Yard — Area Overview</h2>
      <p id="headline" style="font-size:18px">Loading…</p>

      <div class="kpis">
        <div class="kpi"><div class="muted">Now</div><b id="kpiNow">—</b></div>
        <div class="kpi"><div class="muted">Expected peak</div><b id="kpiPeak">—</b></div>
        <div class="kpi"><div class="muted">Confidence</div><b id="kpiConf">—</b></div>
      </div>

      <div id="alerts"></div>

      <div class="chartWrap">
        <canvas id="venueChart" height="220"></canvas>
      </div>
      <p id="chartNote" class="muted"></p>
    </div>

  </div>
</div>

<script>
async function loadJSON(p){
  try{ const r=await fetch(p,{cache:"no-store"}); return r.ok?await r.json():null; }
  catch{ return null; }
}
const clamp=(n,min,max)=>Math.max(min,Math.min(max,n));

let dashboard={}, history=[], forecast=[];
let venues=[], activeVenue=null;

function isTrackedVenue(v){
  const n=(v.name||"").toLowerCase();
  return n.includes("morty") && n.includes("bob");
}

/* ---------- DROPDOWN ---------- */
function renderDropdown(filter=""){
  const box=document.getElementById("venueDropdown");
  box.innerHTML="";
  const f=filter.toLowerCase();

  venues
    .filter(v=>v.name.toLowerCase().includes(f))
    .sort((a,b)=>isTrackedVenue(b)-isTrackedVenue(a))
    .forEach(v=>{
      const d=document.createElement("div");
      d.className="dropdown-item"+(isTrackedVenue(v)?" tracked":"");
      d.innerHTML=`
        <strong>${isTrackedVenue(v)?"⭐ ":""}${v.name}</strong>
        <div class="meta">
          ${v.distance_km?.toFixed(2)||"?"}km · ★${v.rating||"?"}
        </div>`;
      d.onclick=()=>{
        activeVenue=v;
        document.getElementById("venueSearch").value=v.name;
        box.style.display="none";
        update();
      };
      box.appendChild(d);
    });
  box.style.display="block";
}

document.getElementById("venueSearch").addEventListener("input",e=>{
  renderDropdown(e.target.value);
});
document.getElementById("venueSearch").addEventListener("focus",()=>{
  renderDropdown("");
});

/* ---------- DEMAND LOGIC ---------- */
const areaNow=()=>history.at(-1)?.busyness ?? forecast[0]?.busyness ?? 55;
const venueMultiplier=v=>{
  if(!v) return 1;
  return clamp(0.8+(v.transit_reliance||0.8)*0.3,0.75,1.15);
};
const venueNow=()=>Math.round(areaNow()*venueMultiplier(activeVenue));

function buildAlerts(){
  const el=document.getElementById("alerts");
  el.innerHTML="";
  if(!activeVenue){
    el.innerHTML+=`<div class="alert good">
      Coal Drops Yard is driven by commuter + leisure crossover. Select a venue to see tailored actions.
    </div>`;
    return;
  }

  el.innerHTML+=`<div class="alert good">
    Why busy: commuter footfall + food-led dwell time around Coal Drops Yard.
  </div>`;

  el.innerHTML+=`<div class="alert warn">
    What to do: front-load prep, watch queue conversion, and stage staff 30 min before peak.
  </div>`;
}

function update(){
  document.getElementById("venueTitle").textContent=
    activeVenue?activeVenue.name:"Coal Drops Yard — Area Overview";

  document.getElementById("headline").textContent=
    (venueNow()>70?"Very busy":"Steady")+" demand right now";

  document.getElementById("kpiNow").textContent=venueNow()+"/100";
  document.getElementById("kpiPeak").textContent="—";
  document.getElementById("kpiConf").textContent=Math.round((activeVenue?0.8:0.7)*100)+"%";

  buildAlerts();
}

/* ---------- INIT ---------- */
(async()=>{
  dashboard=await loadJSON("data/kingscross_dashboard.json")||{};
  history=await loadJSON("data/history/kingscross_history.json")||[];
  forecast=await loadJSON("data/forecast.json")||[];
  venues=dashboard.venues||[];

  document.getElementById("lastUpdated").textContent=
    dashboard.timestamp?"Updated "+new Date(dashboard.timestamp).toLocaleString():"";

  activeVenue=venues.find(isTrackedVenue)||venues[0]||null;
  if(activeVenue) document.getElementById("venueSearch").value=activeVenue.name;
  update();
})();
</script>
</body>
</html>
