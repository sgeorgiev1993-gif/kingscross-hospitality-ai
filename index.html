<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kings Cross Hospitality Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --accent:#f97316;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --good:#22c55e;
  --bad:#f87171;
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:auto;
  padding:24px;
}

h1{color:var(--accent)}
h2{margin-top:0}

.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

canvas{width:100%}

.muted{color:var(--muted);font-size:14px}
.good{color:var(--good)}
.bad{color:var(--bad)}

ul{padding-left:18px}
li{margin-bottom:6px}
</style>
</head>

<body>
<div class="container">
  <h1>Kings Cross Hospitality Intelligence</h1>

  <!-- WEATHER -->
  <div class="card">
    <h2>Weather</h2>
    <p id="weather" class="muted">Loading…</p>
  </div>

  <!-- TRANSPORT -->
  <div class="card">
    <h2>Transport Status</h2>
    <ul id="transport"></ul>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h2>Last 24h Activity</h2>
    <canvas id="historyChart" height="240"></canvas>
    <p id="historyInfo" class="muted"></p>
  </div>

  <!-- FORECAST -->
  <div class="card">
    <h2>Next 72h Forecast</h2>
    <canvas id="forecastChart" height="240"></canvas>
    <p id="forecastNote" class="muted"></p>
  </div>

  <!-- EVENTS -->
  <div class="card">
    <h2>Upcoming Events</h2>
    <ul id="events"></ul>
  </div>
</div>

<script>
/* ---------------- HELPERS ---------------- */
async function loadJSON(path){
  try{
    const r = await fetch(path);
    if(!r.ok) return null;
    return await r.json();
  }catch{
    return null;
  }
}

/* ---------------- CHARTS ---------------- */
function drawLineChart(canvasId, values, color){
  const c = document.getElementById(canvasId);
  if(!c || !values.length) return;

  const ctx = c.getContext("2d");
  const w = c.width = c.offsetWidth;
  const h = c.height;

  ctx.clearRect(0,0,w,h);

  const max = Math.max(...values, 100);
  const min = Math.min(...values, 0);

  const x = i => (i/(values.length-1||1))*w;
  const y = v => h - ((v-min)/(max-min||1))*h;

  ctx.strokeStyle = color;
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  values.forEach((v,i)=>{
    i===0 ? ctx.moveTo(x(i),y(v)) : ctx.lineTo(x(i),y(v));
  });
  ctx.stroke();

  ctx.fillStyle = color;
  values.forEach((v,i)=>{
    ctx.beginPath();
    ctx.arc(x(i),y(v),3.5,0,Math.PI*2);
    ctx.fill();
  });
}

/* ---------------- MAIN ---------------- */
(async()=>{
  const dash     = await loadJSON("data/kingscross_dashboard.json");
  const history  = await loadJSON("data/history/kingscross_history.json") || [];
  const forecast = await loadJSON("data/forecast.json") || [];

  // WEATHER
  if(dash?.weather){
    weather.textContent =
      `${dash.weather.temperature_C}°C · Wind ${dash.weather.windspeed_kmh} km/h · ${dash.weather.condition}`;
  }else{
    weather.textContent = "Weather unavailable";
  }

  // TRANSPORT
  (dash?.tfl || []).forEach(l=>{
    const li = document.createElement("li");
    li.innerHTML =
      `<strong>${l.name}</strong>: <span class="${l.status==="Good Service"?"good":"bad"}">${l.status}</span>`;
    transport.appendChild(li);
  });

  // EVENTS
  (dash?.events || []).forEach(e=>{
    const li = document.createElement("li");
    li.innerHTML = `<a href="${e.url}" target="_blank">${e.name}</a>`;
    events.appendChild(li);
  });

  // HISTORY CHART
  if(history.length){
    const busyness = history.map(h=>h.busyness ?? 50);
    drawLineChart("historyChart", busyness, "#f97316");

    const avg = Math.round(busyness.reduce((a,b)=>a+b,0)/busyness.length);
    historyInfo.textContent =
      `Average today: ${avg}/100 · ${busyness.length} data points`;
  }else{
    historyInfo.textContent = "Collecting data…";
  }

  // FORECAST CHART
  if(forecast.length){
    const vals = forecast.map(f=>f.busyness ?? 50);
    drawLineChart("forecastChart", vals, "#fb923c");

    forecastNote.textContent =
      `Confidence: ${forecast[0]?.confidence||"low"} · ${forecast.some(f=>f.rush_hour)?"Rush hours ahead":""}`;
  }else{
    forecastNote.textContent = "Forecast unavailable";
  }
})();
</script>
</body>
</html>
