<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kings Cross Hospitality Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --accent:#f97316;
  --text:#e5e7eb;
  --muted:#9ca3af;
  --good:#22c55e;
  --bad:#f87171;
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:auto;
  padding:24px;
}

h1{color:var(--accent)}
h2{margin-top:0}

.card{
  background:var(--card);
  border-radius:18px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

canvas{width:100%}

.muted{color:var(--muted);font-size:14px}

.badge{
  display:inline-block;
  padding:4px 10px;
  border-radius:12px;
  background:rgba(249,115,22,.15);
  color:#f97316;
  font-size:12px;
  margin-left:8px;
}

ul{padding-left:18px}
li{margin-bottom:6px}
.good{color:var(--good)}
.bad{color:var(--bad)}
</style>
</head>

<body>
<div class="container">
  <h1>Kings Cross Hospitality Intelligence</h1>

  <!-- WEATHER -->
  <div class="card">
    <h2>Weather</h2>
    <p id="weather" class="muted">Loadingâ€¦</p>
  </div>

  <!-- TRANSPORT -->
  <div class="card">
    <h2>Transport Status</h2>
    <ul id="transport"></ul>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h2>24h Activity Signals <span class="badge">warming up</span></h2>
    <canvas id="historyChart"></canvas>
    <p id="historyInfo" class="muted"></p>
    <p class="muted">
      Combined signals from weather, transport disruption and local activity.
    </p>
  </div>

  <!-- EVENTS -->
  <div class="card">
    <h2>Upcoming Events</h2>
    <ul id="events"></ul>
  </div>
</div>

<script>
/* -----------------------------
   UTIL
----------------------------- */
async function loadJSON(path){
  try{
    const r = await fetch(path);
    if(!r.ok) return null;
    return await r.json();
  }catch{
    return null;
  }
}

/* -----------------------------
   EVENT OVERLAYS
----------------------------- */
function drawEventOverlays(ctx, events, historyLength, width, height){
  if(!events || events.length === 0) return;

  const now = new Date();

  ctx.save();
  ctx.strokeStyle = "rgba(249,115,22,0.35)";
  ctx.fillStyle   = "rgba(249,115,22,0.9)";
  ctx.setLineDash([6,6]);
  ctx.font = "11px system-ui";

  events.forEach(ev=>{
    if(!ev.start) return;

    const evTime = new Date(ev.start);
    const hoursAgo = Math.round((now - evTime) / 36e5);

    const index = historyLength - hoursAgo - 1;
    if(index < 0 || index >= historyLength) return;

    const x = (index / Math.max(historyLength - 1,1)) * width;

    ctx.beginPath();
    ctx.moveTo(x,0);
    ctx.lineTo(x,height);
    ctx.stroke();

    ctx.setLineDash([]);
    ctx.fillText("ðŸŽŸ " + ev.name.slice(0,22), x + 4, 14);
    ctx.setLineDash([6,6]);
  });

  ctx.restore();
}

/* -----------------------------
   HISTORY CHART
----------------------------- */
function drawMultiLineHistory(history){
  const canvas = document.getElementById("historyChart");
  const ctx = canvas.getContext("2d");
  const w = canvas.width = canvas.offsetWidth;
  const h = canvas.height = 240;

  ctx.clearRect(0,0,w,h);

  if(!history || history.length === 0){
    ctx.fillStyle="#9ca3af";
    ctx.font="14px system-ui";
    ctx.fillText("Collecting dataâ€¦",12,30);
    return;
  }

  const busyness = history.map(h => h.busyness ?? 50);
  const max = Math.max(...busyness,100);
  const min = Math.min(...busyness,0);

  const x = i => (i / Math.max(busyness.length - 1,1)) * w;
  const y = v => h - ((v - min) / Math.max(max - min,1)) * (h - 30);

  ctx.strokeStyle="#f97316";
  ctx.lineWidth=2.8;
  ctx.beginPath();
  busyness.forEach((v,i)=>{
    i===0 ? ctx.moveTo(x(i),y(v)) : ctx.lineTo(x(i),y(v));
  });
  ctx.stroke();

  ctx.fillStyle="#f97316";
  busyness.forEach((v,i)=>{
    ctx.beginPath();
    ctx.arc(x(i),y(v),3.5,0,Math.PI*2);
    ctx.fill();
  });

  drawEventOverlays(ctx, window.__events || [], history.length, w, h);

  const avg = Math.round(busyness.reduce((a,b)=>a+b,0)/busyness.length);
  document.getElementById("historyInfo").textContent =
    `Average activity today: ${avg}/100 Â· ${busyness.length} data points collected`;
}

/* -----------------------------
   LOAD DATA
----------------------------- */
(async()=>{
  const dashboard = await loadJSON("data/kingscross_dashboard.json");
  const history   = await loadJSON("data/history/kingscross_history.json");

  window.__events = dashboard?.events || [];

  // WEATHER
  if(dashboard?.weather?.temperature_C !== undefined){
    weather.textContent =
      `${dashboard.weather.temperature_C}Â°C, Wind ${dashboard.weather.windspeed_kmh} km/h (${dashboard.weather.condition})`;
  }else{
    weather.textContent = "Weather data unavailable";
  }

  // TRANSPORT
  (dashboard?.tfl || []).forEach(l=>{
    const li=document.createElement("li");
    li.innerHTML =
      `<strong>${l.name}</strong>: <span class="${l.status==="Good Service"?"good":"bad"}">${l.status}</span>`;
    transport.appendChild(li);
  });

  // EVENTS
  (dashboard?.events || []).forEach(e=>{
    const li=document.createElement("li");
    li.innerHTML = `<a href="${e.url}" target="_blank">${e.name}</a>`;
    events.appendChild(li);
  });

  drawMultiLineHistory(history || []);
})();
</script>
</body>
</html>
