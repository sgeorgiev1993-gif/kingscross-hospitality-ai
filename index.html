<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kings Cross Hospitality Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
body {
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
  background:#0b0d12;
  color:#e5e7eb;
}
.container {
  max-width:1100px;
  margin:auto;
  padding:24px;
}
h1 { color:#f97316; margin-bottom:6px; }
h2 { margin-top:0; }
.card {
  background:#121622;
  border-radius:18px;
  padding:20px;
  margin-bottom:20px;
  box-shadow:0 20px 40px rgba(0,0,0,.35);
}
canvas { width:100%; }
.muted { color:#9ca3af; font-size:14px; }
.good { color:#22c55e; font-weight:600; }
.bad { color:#f87171; font-weight:600; }
.warn { color:#fbbf24; font-weight:600; }
a { color:#f97316; text-decoration:none; }
ul { padding-left:18px; }
li { margin-bottom:6px; }
</style>
</head>

<body>
<div class="container">

  <h1>Kings Cross Hospitality Intelligence</h1>
  <p class="muted">Live conditions, trends & short-term forecast</p>

  <!-- WEATHER -->
  <div class="card">
    <h2>ðŸŒ¤ Weather</h2>
    <p id="weather">Loadingâ€¦</p>
  </div>

  <!-- TRANSPORT -->
  <div class="card">
    <h2>ðŸš‡ Transport Status</h2>
    <ul id="transport"></ul>
  </div>

  <!-- MULTI-LINE CHART -->
  <div class="card">
    <h2>ðŸ“ˆ Activity & Forecast</h2>
    <canvas id="busynessChart" height="240"></canvas>
    <p class="muted">Busyness, temperature & 12h forecast</p>
  </div>

  <!-- EVENTS -->
  <div class="card">
    <h2>ðŸŽŸ Upcoming Events</h2>
    <ul id="events"></ul>
  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
async function loadJSON(path) {
  try {
    const r = await fetch(path);
    if (!r.ok) throw new Error("Missing " + path);
    return await r.json();
  } catch {
    return null;
  }
}

(async () => {
  const dashboard = await loadJSON("data/kingscross_dashboard.json") || {};

  /* ---------------- WEATHER ---------------- */
  const w = dashboard.weather;
  document.getElementById("weather").textContent = w?.temperature_C !== undefined
    ? `${w.temperature_C}Â°C Â· Wind ${w.windspeed_kmh} km/h Â· ${w.condition || ""}`
    : "No weather data";

  /* ---------------- TRANSPORT ---------------- */
  const transportEl = document.getElementById("transport");
  (dashboard.tfl || []).forEach(l => {
    const li = document.createElement("li");
    const cls =
      l.status === "Good Service" ? "good" :
      l.status.includes("Minor") ? "warn" : "bad";
    li.innerHTML = `<strong>${l.name}</strong>: <span class="${cls}">${l.status}</span>`;
    transportEl.appendChild(li);
  });

  /* ---------------- CHART DATA ---------------- */
  const history = await loadJSON("data/history/signals_history.json") || [];
  const forecast = await loadJSON("data/forecast.json") || [];

  const histLabels = history.map(h =>
    new Date(h.timestamp).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
  );

  const histBusyness = history.map(h => h.busyness);
  const histTemp = history.map(h => h.temperature);

  const forecastLabels = forecast.map(f =>
    new Date(f.time).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'})
  );
  const forecastBusyness = forecast.map(f => f.busyness);

  /* ---------------- MULTI-LINE CHART ---------------- */
  const ctx = document.getElementById("busynessChart").getContext("2d");

  new Chart(ctx, {
    type: "line",
    data: {
      labels: [...histLabels, ...forecastLabels],
      datasets: [
        {
          label: "Busyness %",
          data: histBusyness,
          borderColor: "#f97316",
          backgroundColor: "rgba(249,115,22,.15)",
          tension: .35
        },
        {
          label: "Temperature Â°C",
          data: histTemp,
          borderColor: "#38bdf8",
          yAxisID: "yTemp",
          tension: .35
        },
        {
          label: "Forecast",
          data: new Array(histBusyness.length).fill(null).concat(forecastBusyness),
          borderColor: "#22c55e",
          borderDash: [6,6],
          tension: .35
        }
      ]
    },
    options: {
      responsive: true,
      interaction: { mode: "index", intersect: false },
      plugins: {
        legend: { labels: { color: "#e5e7eb" } }
      },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { color: "#e5e7eb" },
          grid: { color: "rgba(255,255,255,.06)" },
          title: { display:true, text:"Busyness %", color:"#e5e7eb" }
        },
        yTemp: {
          position: "right",
          beginAtZero: true,
          ticks: { color: "#38bdf8" },
          grid: { drawOnChartArea:false },
          title: { display:true, text:"Â°C", color:"#38bdf8" }
        },
        x: {
          ticks: { color:"#9ca3af" },
          grid: { color:"rgba(255,255,255,.04)" }
        }
      }
    }
  });

  /* ---------------- EVENTS ---------------- */
  const events = await loadJSON("data/events.json") || dashboard.events || [];
  const eventsEl = document.getElementById("events");

  if (!events.length) {
    eventsEl.innerHTML = "<li class='muted'>No upcoming events</li>";
  } else {
    events.slice(0,5).forEach(e => {
      const li = document.createElement("li");
      li.innerHTML = `<a href="${e.url}" target="_blank">${e.name}</a>`;
      eventsEl.appendChild(li);
    });
  }

})();
</script>

</body>
</html>
