<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Kings Cross Hospitality Intelligence</title>

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --border:rgba(148,163,184,.14);
  --text:#e5e7eb;
  --muted:#9ca3af;

  --accent:#f97316;
  --accent2:#60a5fa;
  --good:#22c55e;
  --warn:#fbbf24;
  --bad:#f87171;

  --shadow:0 20px 40px rgba(0,0,0,.45);
}

*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:
    radial-gradient(1100px 520px at 10% -10%, rgba(249,115,22,.22), transparent 60%),
    radial-gradient(900px 520px at 85% -5%, rgba(96,165,250,.14), transparent 55%),
    var(--bg);
  color:var(--text);
}

.wrap{max-width:1240px;margin:auto;padding:18px}
h1{margin:0;font-size:22px}
h2{margin:0;font-size:16px}
p{margin:6px 0}
.muted{color:var(--muted);font-size:13px}

.grid{
  display:grid;
  grid-template-columns:360px 1fr;
  gap:16px;
}
@media(max-width:980px){
  .grid{grid-template-columns:1fr}
}

.card{
  background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
  border:1px solid var(--border);
  border-radius:18px;
  padding:14px;
  box-shadow:var(--shadow);
}

/* Pills / tags */
.pill{
  padding:2px 8px;
  border-radius:999px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  font-size:12px;
}
.pill.good{color:#a7f3d0;border-color:rgba(34,197,94,.3)}
.pill.warn{color:#fde68a;border-color:rgba(251,191,36,.3)}
.pill.bad{color:#fecaca;border-color:rgba(248,113,113,.3)}

/* Venue list */
.venue{
  padding:10px;
  border-radius:14px;
  border:1px solid var(--border);
  margin-bottom:8px;
  cursor:pointer;
  background:rgba(255,255,255,.03);
}
.venue:hover{background:rgba(249,115,22,.10)}
.venue.active{
  background:rgba(249,115,22,.16);
  border-color:rgba(249,115,22,.45);
}
.venue.hard{
  box-shadow:0 0 0 4px rgba(249,115,22,.15);
}

/* Panels */
.panel{
  margin-top:14px;
  border-radius:16px;
  border:1px solid var(--border);
  background:rgba(255,255,255,.03);
  padding:12px;
}

/* Chart */
canvas{width:100%;display:block}
.tooltip{
  position:absolute;
  pointer-events:none;
  background:rgba(17,24,39,.96);
  border:1px solid var(--border);
  color:var(--text);
  padding:10px;
  border-radius:12px;
  font-size:12px;
  opacity:0;
  transform:translate(-50%,-115%);
  z-index:10;
}
</style>
</head>

<body>
<div class="wrap">

<h1>Kings Cross Hospitality Intelligence</h1>
<p class="muted" id="lastUpdated">Loadingâ€¦</p>

<div class="grid">

<!-- LEFT -->
<div class="card">
  <h2>Food places</h2>
  <div id="venueList"></div>
  <p class="muted" id="venuesMeta"></p>
</div>

<!-- RIGHT -->
<div class="card">
  <h2 id="venueTitle">Area overview</h2>
  <p id="headline">Loadingâ€¦</p>

  <div class="panel">
    <canvas id="venueChart" height="240"></canvas>
    <div id="chartTip" class="tooltip"></div>
    <p id="chartNote" class="muted"></p>
  </div>

  <div class="panel">
    <h2 style="font-size:14px">Why demand changes</h2>
    <ul id="drivers"></ul>
  </div>

  <div class="panel">
    <h2 style="font-size:14px">Operational implications</h2>
    <ul id="implications"></ul>
  </div>

  <!-- ðŸ”¥ NEW: Seasonal / anomaly explainer -->
  <div class="panel">
    <h2 style="font-size:14px">Seasonal anomalies & deviations</h2>
    <div id="seasonalExplainer" class="muted">Loading seasonal signalsâ€¦</div>
  </div>

</div>
</div>
</div>

<script>
/* ---------------- Utilities ---------------- */
async function loadJSON(p){
  try{ const r=await fetch(p,{cache:"no-store"}); return r.ok?await r.json():null;}
  catch{return null;}
}
function clamp(n,min,max){return Math.max(min,Math.min(max,n));}
function norm(s){return String(s||"").toLowerCase();}

/* ---------------- Anomaly Evidence Helper ---------------- */
function buildAnomalyEvidence(a, dashboard, history){
  const evidence = [];

  if(a.type === "volatile_demand"){
    evidence.push("Short-term demand variance exceeded recent baseline");
  }
  if(a.type === "unexpected_peak"){
    evidence.push("Observed demand exceeded forecasted range");
  }
  if(a.type === "prolonged_peak"){
    evidence.push("Elevated demand persisted longer than historical norm");
  }

  const tp = dashboard?.transit_pressure?.score;
  if(tp !== undefined){
    if(tp < 55) evidence.push("Transport conditions remained broadly stable");
    else evidence.push("Transport pressure elevated during observation window");
  }

  const w = dashboard?.weather;
  if(w?.temperature_C !== undefined){
    if(w.temperature_C < 5) evidence.push("Cold weather typically suppresses discretionary footfall");
    else if(w.temperature_C >= 12 && w.temperature_C <= 18)
      evidence.push("Mild weather supports pedestrian activity");
  }

  if(history.length < 24){
    evidence.push("Limited historical depth for seasonal comparison");
  }

  return evidence;
}

/* ---------------- State ---------------- */
let dashboard={},history=[],forecast=[],anomalies=[];
let venues=[],activeVenue=null;

/* ---------------- Confidence ---------------- */
function calcConfidence(v){
  let c=0.45;
  if(v.rating>=4.4) c+=0.15;
  if((v.reviews||0)>=200) c+=0.1;
  if(v.distance_km<0.5) c+=0.1;
  if(history.length>=24) c+=0.1;
  return clamp(c,0.35,0.95);
}

/* ---------------- Venue logic ---------------- */
function venueMultiplier(v){
  const tr=v.transit_reliance||0.8;
  return clamp(0.8+tr*0.35,0.8,1.2);
}
function areaNow(){
  return history.at(-1)?.busyness ?? forecast[0]?.busyness ?? 55;
}
function venueNow(){
  return activeVenue ? Math.round(areaNow()*venueMultiplier(activeVenue)) : areaNow();
}

/* ---------------- Render venues ---------------- */
function renderVenues(){
  const el=document.getElementById("venueList");
  el.innerHTML="";
  venues.forEach(v=>{
    const d=document.createElement("div");
    const hard=norm(v.name).includes("morty");
    d.className=`venue ${activeVenue?.id===v.id?"active":""} ${hard?"hard":""}`;
    d.innerHTML=`
      <b>${v.name}</b><br>
      <span class="pill">${v.distance_km.toFixed(2)} km</span>
      <span class="pill">${v.rating?.toFixed(1)||"â€”"}â˜…</span>
      <span class="pill">${Math.round(calcConfidence(v)*100)}%</span>
    `;
    d.onclick=()=>{activeVenue=v;update();};
    el.appendChild(d);
  });
  document.getElementById("venuesMeta").textContent=`${venues.length} places loaded`;
}

/* ---------------- Drivers ---------------- */
function buildDrivers(){
  const ul=document.getElementById("drivers");
  ul.innerHTML="";
  const ctx=dashboard.context||{};
  [
    `Holiday phase: ${ctx.holiday_phase||"normal"}`,
    `Transit pressure: ${dashboard.transit_pressure?.level||"â€”"}`,
    dashboard.weather?`Weather: ${dashboard.weather.temperature_C}Â°C`:null
  ].filter(Boolean).forEach(t=>{
    const li=document.createElement("li");
    li.textContent=t;
    ul.appendChild(li);
  });
}

/* ---------------- Implications ---------------- */
function buildImplications(){
  const ul=document.getElementById("implications");
  ul.innerHTML="";
  const now=venueNow();
  const msgs=now>=75
    ?["Expect queues","Shorter dwell time","Prep pressure likely"]
    :["Steady flow","Monitor changes","Conversion matters"];
  msgs.forEach(m=>{
    const li=document.createElement("li");
    li.textContent=m;
    ul.appendChild(li);
  });
}

/* ---------------- Seasonal anomalies ---------------- */
function renderSeasonalExplainer(){
  const el=document.getElementById("seasonalExplainer");
  if(!anomalies.length){
    el.textContent="No seasonal anomalies detected yet. System is still learning the holiday baseline.";
    return;
  }
  el.innerHTML=anomalies.slice(-3).reverse().map(a=>`
    <div style="margin-top:10px">
      <b>${a.type.replaceAll("_"," ")}</b>
      Â· <span class="pill ${a.severity}">${a.severity}</span>
      Â· ${(a.confidence*100).toFixed(0)}%
      <div class="muted">${a.explanation}</div>
    </div>
  `).join("");
}

/* ---------------- Chart ---------------- */
function drawChart(){
  const c=document.getElementById("venueChart");
  const ctx=c.getContext("2d");
  const w=c.width=c.offsetWidth,h=c.height;
  ctx.clearRect(0,0,w,h);
  if(!forecast.length) return;

  const area=forecast.map(f=>f.busyness);
  const m=activeVenue?venueMultiplier(activeVenue):1;
  const venue=area.map(v=>Math.round(v*m));

  const xs=area.map((_,i)=>i*(w/(area.length-1)));
  const y=v=>h-(v/100)*h;

  ctx.strokeStyle="rgba(96,165,250,.9)";
  ctx.beginPath(); area.forEach((v,i)=>i?ctx.lineTo(xs[i],y(v)):ctx.moveTo(xs[i],y(v))); ctx.stroke();

  ctx.strokeStyle="rgba(249,115,22,.95)";
  ctx.beginPath(); venue.forEach((v,i)=>i?ctx.lineTo(xs[i],y(v)):ctx.moveTo(xs[i],y(v))); ctx.stroke();
}

/* ---------------- Update ---------------- */
function update(){
  document.getElementById("venueTitle").textContent=activeVenue?activeVenue.name:"Area overview";
  document.getElementById("headline").textContent=`${venueNow()}/100 demand now`;
  buildDrivers();
  buildImplications();
  drawChart();
}

/* ---------------- Init ---------------- */
(async()=>{
  dashboard=await loadJSON("data/kingscross_dashboard.json")||{};
  history=await loadJSON("data/history/kingscross_history.json")||[];
  forecast=await loadJSON("data/forecast.json")||[];
  anomalies=await loadJSON("data/anomalies.json")||[];
  venues=dashboard.venues||[];

  document.getElementById("lastUpdated").textContent=
    dashboard.timestamp?`Updated ${new Date(dashboard.timestamp).toLocaleString()}`:"";

  activeVenue=venues.find(v=>norm(v.name).includes("morty"))||venues[0]||null;
  renderVenues();
  update();
  renderSeasonalExplainer();
})();
</script>
</body>
</html>
