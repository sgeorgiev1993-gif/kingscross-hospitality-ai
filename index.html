<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kings Cross Hospitality Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
:root{
  --bg:#0b0d12;
  --card:#121622;
  --accent:#f97316;
  --good:#22c55e;
  --bad:#f87171;
  --muted:#9ca3af;
  --text:#e5e7eb;
}

body{
  margin:0;
  font-family:system-ui,sans-serif;
  background:var(--bg);
  color:var(--text);
}

.container{
  max-width:1200px;
  margin:auto;
  padding:24px;
}

h1{color:var(--accent);margin-bottom:12px}
h2{margin:0 0 6px}

.card{
  background:var(--card);
  border-radius:18px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 20px 40px rgba(0,0,0,.4);
}

.muted{color:var(--muted);font-size:14px}
.good{color:var(--good)}
.bad{color:var(--bad)}

ul{padding-left:18px}
li{margin-bottom:6px}

canvas{width:100%}

/* ---------- HEATMAP ---------- */
.heatmap{
  display:grid;
  grid-template-columns: 90px repeat(24, 1fr);
  gap:6px;
  margin-top:12px;
}

.hm-label{
  font-size:12px;
  color:var(--muted);
  display:flex;
  align-items:center;
}

.hm-cell{
  height:34px;
  border-radius:6px;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:11px;
  font-weight:700;
  color:#111;
}

.hm-note{
  margin-top:10px;
  font-size:13px;
  color:var(--muted);
}
</style>
</head>

<body>
<div class="container">
  <h1>Kings Cross Hospitality Intelligence</h1>

  <!-- WEATHER -->
  <div class="card">
    <h2>Weather</h2>
    <p id="weather" class="muted">Loadingâ€¦</p>
  </div>

  <!-- TRANSPORT -->
  <div class="card">
    <h2>Transport Status</h2>
    <ul id="transport"></ul>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <h2>Last 24h Activity</h2>
    <canvas id="historyChart" height="220"></canvas>
    <p id="historyInfo" class="muted"></p>
  </div>

  <!-- HEATMAP (A + A+) -->
  <div class="card">
    <h2>Hourly Demand Heatmap</h2>
    <p class="muted">
      Observed demand by hour Â· Today vs Yesterday vs 7-day average
    </p>
    <div id="heatmap"></div>
    <p id="heatmapInsight" class="hm-note"></p>
  </div>

  <!-- FORECAST -->
  <div class="card">
    <h2>Next 12h Forecast</h2>
    <canvas id="forecastChart" height="220"></canvas>
    <p id="forecastNote" class="muted"></p>
  </div>

  <!-- EVENTS -->
  <div class="card">
    <h2>Upcoming Events</h2>
    <ul id="events"></ul>
  </div>
</div>

<script>
async function loadJSON(p){
  try{
    const r = await fetch(p,{cache:"no-store"});
    if(!r.ok) return null;
    return await r.json();
  }catch{return null}
}

/* ---------- HISTORY ---------- */
function drawHistory(hist){
  const c=document.getElementById("historyChart");
  const ctx=c.getContext("2d");
  const w=c.width=c.offsetWidth;
  const h=c.height;

  if(!hist.length){
    ctx.fillStyle="#9ca3af";
    ctx.fillText("Collecting dataâ€¦",12,30);
    return;
  }

  const vals=hist.map(h=>h.busyness||50);
  const max=Math.max(...vals,100);
  const min=Math.min(...vals,0);

  ctx.strokeStyle="#f97316";
  ctx.lineWidth=2.5;
  ctx.beginPath();
  vals.forEach((v,i)=>{
    const x=i/(vals.length-1||1)*w;
    const y=h-(v-min)/(max-min||1)*h;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });
  ctx.stroke();

  const avg=Math.round(vals.reduce((a,b)=>a+b,0)/vals.length);
  document.getElementById("historyInfo").textContent =
    `Average activity today: ${avg}/100 Â· ${vals.length} points`;
}

/* ---------- HEATMAP (A + A+) ---------- */
function heatColor(v){
  if(v==null) return "#1f2933";
  if(v<40) return "#93c5fd";
  if(v<60) return "#fbbf24";
  if(v<80) return "#fb923c";
  return "#ef4444";
}

function buildHeatmap(history){
  const rows={today:new Array(24).fill(null),yesterday:new Array(24).fill(null),avg7:new Array(24).fill(null)};
  const now=new Date();
  const today=now.toDateString();
  const yest=new Date(now-864e5).toDateString();

  const byDay={};
  history.forEach(h=>{
    const d=new Date(h.timestamp);
    const day=d.toDateString();
    const hr=d.getHours();
    byDay[day]??={};
    byDay[day][hr]??=[];
    byDay[day][hr].push(h.busyness||50);
  });

  const avg=a=>Math.round(a.reduce((x,y)=>x+y,0)/a.length);

  Object.entries(byDay).forEach(([day,hrs])=>{
    Object.entries(hrs).forEach(([h,v])=>{
      const val=avg(v);
      if(day===today) rows.today[h]=val;
      if(day===yest) rows.yesterday[h]=val;
      rows.avg7[h]??=[];
      rows.avg7[h].push(val);
    });
  });

  rows.avg7=rows.avg7.map(v=>v?avg(v):null);
  return rows;
}

function renderHeatmap(rows){
  const root=document.getElementById("heatmap");
  root.className="heatmap";
  root.innerHTML="";

  ["",...Array.from({length:24},(_,i)=>i+":00")].forEach(h=>{
    root.innerHTML+=`<div class="hm-label">${h}</div>`;
  });

  Object.entries(rows).forEach(([k,arr])=>{
    root.innerHTML+=`<div class="hm-label">${k}</div>`;
    arr.forEach(v=>{
      root.innerHTML+=`<div class="hm-cell" style="background:${heatColor(v)}">${v??"â€“"}</div>`;
    });
  });

  // A+ insight
  let insight="";
  rows.today.forEach((v,i)=>{
    const avg=rows.avg7[i];
    if(v!=null&&avg!=null){
      if(v-avg>15) insight=`ðŸ”¥ Unusually busy at ${i}:00`;
      if(avg-v>15) insight=`ðŸŸ¦ Quieter than usual at ${i}:00`;
    }
  });
  document.getElementById("heatmapInsight").textContent = insight || "Demand within normal range today.";
}

/* ---------- PAGE LOAD ---------- */
(async()=>{
  const dash=await loadJSON("data/kingscross_dashboard.json");
  const hist=await loadJSON("data/history/kingscross_history.json")||[];
  const fore=await loadJSON("data/forecast.json");

  if(dash?.weather){
    weather.textContent=`${dash.weather.temperature_C}Â°C Â· Wind ${dash.weather.windspeed_kmh} km/h Â· ${dash.weather.condition}`;
  }

  (dash?.tfl||[]).forEach(l=>{
    const li=document.createElement("li");
    li.innerHTML=`<strong>${l.name}</strong>: <span class="${l.status==="Good Service"?"good":"bad"}">${l.status}</span>`;
    transport.appendChild(li);
  });

  (dash?.events||[]).forEach(e=>{
    const li=document.createElement("li");
    li.innerHTML=`<a href="${e.url}" target="_blank">${e.name}</a>`;
    events.appendChild(li);
  });

  drawHistory(hist);
  const heat=buildHeatmap(hist);
  renderHeatmap(heat);
})();
</script>
</body>
</html>
