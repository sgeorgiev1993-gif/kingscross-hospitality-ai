<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Kings Cross Hospitality Intelligence</title>
<meta name="viewport" content="width=device-width,initial-scale=1">

<style>
/* =======================
   THEME
======================= */
:root{
  --bg:#0b0d12;
  --card:#121622;
  --accent:#f97316;
  --accent-soft:rgba(249,115,22,.15);
  --text:#e5e7eb;
  --muted:#9ca3af;
  --good:#22c55e;
  --bad:#f87171;
}

/* =======================
   BASE
======================= */
body{
  margin:0;
  font-family:system-ui,-apple-system,BlinkMacSystemFont,sans-serif;
  background:
    radial-gradient(900px 500px at 20% -10%, rgba(249,115,22,.06), transparent 45%),
    var(--bg);
  color:var(--text);
}

.container{
  max-width:1100px;
  margin:auto;
  padding:20px 16px 80px;
}

h1{color:var(--accent);margin:0 0 4px}
h2{margin:0;font-size:18px}

.muted{color:var(--muted);font-size:14px}
.good{color:var(--good)}
.bad{color:var(--bad)}

a{color:var(--accent);text-decoration:none}

/* =======================
   CARDS
======================= */
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.04),transparent),var(--card);
  border-radius:18px;
  padding:16px;
  margin-bottom:14px;
  box-shadow:0 18px 40px rgba(0,0,0,.45);
}

.row{
  display:grid;
  grid-template-columns:1fr;
  gap:14px;
}
@media(min-width:900px){
  .row{grid-template-columns:1fr 1fr}
}

/* =======================
   MOBILE COLLAPSIBLE
======================= */
.sectionToggle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  cursor:pointer;
}
.sectionToggle span{
  font-size:14px;
  color:var(--muted);
}
.sectionBody{margin-top:10px}

@media(max-width:720px){
  .collapsible .sectionBody{display:none}
  .collapsible.open .sectionBody{display:block}
}

/* =======================
   RIGHT NOW STICKY (MOBILE)
======================= */
#stickyNow{
  display:none;
}

@media(max-width:720px){
  #stickyNow{
    display:flex;
    position:fixed;
    bottom:0;
    left:0;
    right:0;
    z-index:99;
    background:rgba(18,22,34,.95);
    border-top:1px solid rgba(249,115,22,.2);
    padding:10px 14px;
    justify-content:space-between;
    align-items:center;
    backdrop-filter: blur(6px);
  }
  #stickyNow strong{color:var(--accent)}
}

/* =======================
   CANVAS
======================= */
canvas{width:100%;display:block;margin-top:10px}

/* =======================
   OPS RECO
======================= */
.recoItem{
  border-radius:14px;
  padding:12px;
  border:1px solid rgba(148,163,184,.12);
  background:rgba(255,255,255,.03);
  margin-top:8px;
}
.recoItem b{display:block;margin-bottom:4px}
</style>
</head>

<body>

<!-- MOBILE STICKY BAR -->
<div id="stickyNow">
  <div>Now: <strong id="stickyScore">–</strong></div>
  <div id="stickyLabel" class="muted">loading…</div>
</div>

<div class="container">
  <h1>Kings Cross Hospitality Intelligence</h1>
  <p id="lastUpdated" class="muted">Loading…</p>

  <!-- WEATHER + TRANSPORT -->
  <div class="row">
    <div class="card">
      <h2>Weather</h2>
      <p id="weather" class="muted">Loading…</p>
    </div>
    <div class="card">
      <h2>Transport</h2>
      <ul id="transport"></ul>
      <p id="transportMeta" class="muted"></p>
    </div>
  </div>

  <!-- RIGHT NOW -->
  <div class="card">
    <h2>Right now</h2>
    <p id="insightLine" class="muted">Loading insight…</p>

    <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:10px">
      <div>
        <div class="muted">Activity</div>
        <strong id="kpiNow">–</strong>
      </div>
      <div>
        <div class="muted">Next peak</div>
        <strong id="kpiPeak">–</strong>
      </div>
    </div>
  </div>

  <!-- TODAY VS YESTERDAY -->
  <div class="card">
    <h2>Today vs yesterday</h2>
    <p id="tvsy" class="muted">Warming up…</p>
  </div>

  <!-- HISTORY -->
  <div class="card collapsible open">
    <div class="sectionToggle">
      <h2>Last 24h</h2><span>tap</span>
    </div>
    <div class="sectionBody">
      <canvas id="historyChart" height="240"></canvas>
      <p id="historyInfo" class="muted"></p>
    </div>
  </div>

  <!-- FORECAST -->
  <div class="card collapsible">
    <div class="sectionToggle">
      <h2>Next 12h Forecast</h2><span>tap</span>
    </div>
    <div class="sectionBody">
      <canvas id="forecastChart" height="240"></canvas>
      <p id="forecastNote" class="muted"></p>
    </div>
  </div>

  <!-- OPS -->
  <div class="card collapsible open">
    <div class="sectionToggle">
      <h2>Ops recommendations</h2><span>tap</span>
    </div>
    <div id="reco" class="sectionBody"></div>
  </div>

  <!-- EVENTS -->
  <div class="card collapsible">
    <div class="sectionToggle">
      <h2>Events</h2><span>tap</span>
    </div>
    <div class="sectionBody">
      <ul id="events"></ul>
    </div>
  </div>
</div>

<script>
async function loadJSON(p){
  try{
    const r=await fetch(p,{cache:"no-store"});
    if(!r.ok) return null;
    return await r.json();
  }catch{return null}
}

/* COLLAPSIBLE */
document.addEventListener("click",e=>{
  const h=e.target.closest(".sectionToggle");
  if(!h) return;
  h.parentElement.classList.toggle("open");
});

/* PAGE LOAD */
(async()=>{
  const dash=await loadJSON("data/kingscross_dashboard.json")||{};
  const hist=await loadJSON("data/history/kingscross_history.json")||[];
  const fore=await loadJSON("data/forecast.json")||[];

  if(dash.timestamp){
    lastUpdated.textContent="Last updated: "+new Date(dash.timestamp).toLocaleString();
  }

  if(dash.weather){
    weather.textContent=`${dash.weather.temperature_C}°C · Wind ${dash.weather.windspeed_kmh} km/h · ${dash.weather.condition}`;
  }

  let disrupted=0;
  (dash.tfl||[]).forEach(l=>{
    if(l.status!=="Good Service") disrupted++;
    const li=document.createElement("li");
    li.innerHTML=`<strong>${l.name}</strong>: <span class="${l.status==="Good Service"?"good":"bad"}">${l.status}</span>`;
    transport.appendChild(li);
  });
  transportMeta.textContent= disrupted ? `${disrupted} disrupted lines` : "All lines good";

  const nowScore = hist.length ? hist.at(-1).busyness : (fore[0]?.busyness||50);
  const peak = fore.reduce((a,b)=>b.busyness>a.busyness?b:a,fore[0]||{busyness:nowScore});

  kpiNow.textContent = nowScore+"/100";
  kpiPeak.textContent = peak.busyness+"/100";

  stickyScore.textContent = nowScore+"/100";
  stickyLabel.textContent =
    nowScore>=75?"HOT":
    nowScore>=55?"BUSY":"CALM";

  insightLine.textContent =
    nowScore>=75?"High pressure right now. Expect queues.":
    nowScore>=55?"Steady flow. Watch next peak.":
    "Calm window. Good time to prep.";

  reco.innerHTML="";
  const add=(t,b)=>{const d=document.createElement("div");d.className="recoItem";d.innerHTML=`<b>${t}</b><div class="muted">${b}</div>`;reco.appendChild(d)};
  if(nowScore>=70) add("Staffing","Add 1–2 people for the peak window.");
  else add("Staffing","Lean shift is fine.");

  if(disrupted>=3) add("Prep","Expect uneven waves due to transport.");
  else add("Prep","Normal prep levels.");

})();
</script>
</body>
</html>
