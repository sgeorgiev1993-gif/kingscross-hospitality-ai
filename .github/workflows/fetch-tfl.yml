name: 🚆 Fetch TfL & Rail Status

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  update-tfl:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests

      - name: Fetch TfL + rail data
        env:
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, pathlib

          pathlib.Path("data").mkdir(exist_ok=True)
          tfl_key = os.getenv("TFL_APP_KEY")
          if not tfl_key:
              raise Exception("❌ TFL_APP_KEY missing")

          # --- Modes to fetch ---
          modes = ["tube","overground","dlr","tflrail","nationalrail"]
          all_lines = []

          for mode in modes:
              r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/{mode}/Status?app_key={tfl_key}")
              if r.status_code != 200:
                  print(f"⚠️ {mode} fetch failed:", r.text)
                  continue
              data = r.json()
              all_lines.extend(data)

          # --- Filter for Kings Cross relevant lines ---
          kings_cross_lines = {
              "Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan",
              "Great Northern","Thameslink","London Overground"  # Add more if needed
          }

          tfl_filtered = [
              {"name": l["name"], "mode": l["modeName"], "status": l["lineStatuses"][0]["statusSeverityDescription"]}
              for l in all_lines if l["name"] in kings_cross_lines
          ]

          # --- Save to JSON ---
          output_path = "data/kingscross_tfl.json"
          with open(output_path, "w") as f:
              json.dump(tfl_filtered, f, indent=2)
          print(f"✅ Fetched {len(tfl_filtered)} lines for Kings Cross")
          EOF

      - name: Commit and push updates
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "🚆 Update TfL & rail status [skip ci]" || echo "No changes to commit"
          git push origin main --force
