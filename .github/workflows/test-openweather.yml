name: Daily Kings Cross Weather Logger (No API Key)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 7 * * *" # Runs every day at 07:00 UTC

jobs:
  fetch-weather:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Fetch and Save Weather Data (Open-Meteo)
        run: |
          python - <<'EOF'
          import requests, json, datetime, pathlib

          # Coordinates for King's Cross
          lat, lon = 51.5308, -0.1238
          url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current_weather=true"

          print("ðŸ” Fetching weather data from Open-Meteo...")
          r = requests.get(url)
          if r.status_code != 200:
              print(f"âŒ API failed: {r.status_code}, {r.text}")
              exit(1)

          data = r.json()["current_weather"]
          record = {
              "timestamp": datetime.datetime.utcnow().isoformat(),
              "temperature_C": data["temperature"],
              "windspeed_kmh": data["windspeed"],
              "weather_code": data["weathercode"]
          }

          # Save or append data
          pathlib.Path("data").mkdir(exist_ok=True)
          path = pathlib.Path("data/weather_log.json")

          if path.exists():
              with open(path, "r") as f:
                  log = json.load(f)
          else:
              log = []

          log.append(record)
          with open(path, "w") as f:
              json.dump(log, f, indent=2)

          print(f"âœ… Added new record: {record['temperature_C']}Â°C, wind {record['windspeed_kmh']} km/h")
          EOF

      - name: Commit and Push Data
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/weather_log.json
          git commit -m "ðŸ—“ï¸ Update weather log [skip ci]" || echo "No changes to commit"
          git push
