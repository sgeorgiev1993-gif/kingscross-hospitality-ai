name: KingsCross Data Pipeline

on:
  schedule:
    - cron: '0 * * * *' # hourly
  workflow_dispatch:

jobs:
  fetch-and-generate:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout the repository
      - name: Checkout repo
        uses: actions/checkout@v3

      # 2. Set up Python
      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      # 3. Install dependencies
      - name: Install dependencies
        run: pip install -r requirements.txt

      # 4. Fetch TfL & Rail status
      - name: Fetch TfL & Rail data
        run: python scripts/fetch_tfl.py

      # 5. Fetch Events from Eventbrite
      - name: Fetch Events
        env:
          EVENTBRITE_KEY: ${{ secrets.EVENTBRITE_KEY }}
        run: python scripts/fetch_eventbrite.py

      # 6. Fetch Restaurants/Places reviews
      - name: Fetch Places Reviews
        env:
          GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
        run: python scripts/fetch_places_reviews.py

      # 7. Fetch Weather data
      - name: Fetch Weather
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
        run: python scripts/fetch_weather.py

      # 8. Generate the Dashboard & Reports
      - name: Generate Dashboard
        run: python scripts/generate_weekly_report.py

      # 9. Commit & push updates to gh-pages
      - name: Push Dashboard to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          # Ensure we are on a clean gh-pages branch
          git fetch origin gh-pages:gh-pages || git checkout -b gh-pages
          git reset --hard origin/gh-pages || echo "No remote branch yet"
          git add data/* index.html
          git commit -m "ðŸš€ Update dashboard + events [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force
