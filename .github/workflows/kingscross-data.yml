name: KingsCross Full Dashboard

on:
  schedule:
    - cron: "0 * * * *" # every hour
  workflow_dispatch:

jobs:
  fetch-and-build:
    runs-on: ubuntu-latest
    env:
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
      GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: 3.11

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib python-dotenv

      # --------------------------
      # Fetch TfL & Rail
      # --------------------------
      - name: ðŸš‡ Fetch TfL & Rail
        run: |
          python - <<'EOF'
          import requests, json
          from pathlib import Path

          BASE_URL = "https://api.tfl.gov.uk/Line/Mode"
          MODES = ["tube", "overground", "dlr", "tflrail", "national-rail"]
          DATA_PATH = Path("data/kingscross_tfl.json")

          all_lines_status = {}

          for mode in MODES:
              try:
                  res = requests.get(f"{BASE_URL}/{mode}/Status")
                  res.raise_for_status()
                  lines = res.json()
                  for line in lines:
                      name = line.get("name")
                      status_entries = line.get("lineStatuses", [])
                      status_text = status_entries[0].get("statusSeverityDescription", "Unknown") if status_entries else "Unknown"
                      all_lines_status[name] = {"mode": mode, "status": status_text}
              except Exception as e:
                  print(f"âš ï¸ Error fetching {mode}: {e}")

          DATA_PATH.parent.mkdir(exist_ok=True)
          DATA_PATH.write_text(json.dumps(all_lines_status, indent=2))
          print(f"âœ… TfL & Rail status saved to {DATA_PATH}")
          EOF

      # --------------------------
      # Fetch Eventbrite Events
      # --------------------------
      - name: ðŸŽŸ Fetch Eventbrite Events
        run: |
          python - <<'EOF'
          import requests, json
          from pathlib import Path

          TOKEN = "${{ secrets.EVENTBRITE_TOKEN }}"
          DATA_FILE = Path("data/events.json")
          Path("data").mkdir(exist_ok=True)

          if TOKEN:
              try:
                  url = "https://www.eventbriteapi.com/v3/events/search/"
                  params = {
                      "location.address": "King's Cross, London",
                      "location.within": "2km",
                      "expand": "venue",
                      "token": TOKEN
                  }
                  res = requests.get(url, params=params)
                  res.raise_for_status()
                  events = []
                  for e in res.json().get("events", []):
                      events.append({
                          "name": e.get("name", {}).get("text"),
                          "start": e.get("start", {}).get("local"),
                          "end": e.get("end", {}).get("local"),
                          "url": e.get("url"),
                          "venue": e.get("venue", {}).get("name")
                      })
                  DATA_FILE.write_text(json.dumps(events, indent=2))
                  print(f"âœ… Fetched {len(events)} events")
              except Exception as ex:
                  print(f"âš ï¸ Failed Eventbrite fetch: {ex}")
          else:
              print("âš ï¸ EVENTBRITE_TOKEN not set")
          EOF

      # --------------------------
      # Fetch Google Places / Reviews
      # --------------------------
      - name: ðŸ“ Fetch Google Places & Reviews
        run: python scripts/fetch_places_reviews.py

      # --------------------------
      # Fetch Weather
      # --------------------------
      - name: ðŸŒ¤ Fetch Weather
        run: python scripts/fetch_weather.py

      # --------------------------
      # Fetch News (NewsAPI)
      # --------------------------
      - name: ðŸ“° Fetch News
        run: |
          python - <<'EOF'
          import requests, json
          from pathlib import Path

          API_KEY = "${{ secrets.NEWS_API_KEY }}"
          DATA_FILE = Path("data/news.json")
          Path("data").mkdir(exist_ok=True)

          if API_KEY:
              try:
                  url = f"https://newsapi.org/v2/top-headlines"
                  params = {"q": "King's Cross", "pageSize": 10, "apiKey": API_KEY, "language": "en"}
                  res = requests.get(url, params=params)
                  res.raise_for_status()
                  articles = [{"title": a["title"], "url": a["url"], "source": a["source"]["name"]} for a in res.json().get("articles",[])]
                  DATA_FILE.write_text(json.dumps(articles, indent=2))
                  print(f"âœ… Fetched {len(articles)} news articles")
              except Exception as ex:
                  print(f"âš ï¸ Failed NewsAPI fetch: {ex}")
          else:
              print("âš ï¸ NEWS_API_KEY not set")
          EOF

      # --------------------------
      # Generate Dashboard
      # --------------------------
      - name: ðŸ“Š Generate Dashboard
        run: python scripts/generate_weekly_report.py

      # --------------------------
      # Commit & Push updates
      # --------------------------
      - name: Commit & Push to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add data/ index.html || true
          git commit -m "ðŸš€ Update dashboard + events + news [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force || echo "âš ï¸ Push failed"
