name: Update Kings Cross Dashboard

on:
  schedule:
    - cron: "*/30 * * * *"  # every 30 minutes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          ref: main

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install requests pandas matplotlib pillow

      - name: Create dashboard build directory
        run: mkdir -p dashboard_build/data

      - name: Generate dashboard data
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'EOF'
          import requests, json, datetime, os, pandas as pd, matplotlib.pyplot as plt

          def safe_get(d, key, default=""):
              return d.get(key, default) if isinstance(d, dict) else default

          def fetch_weather():
              url = "https://api.open-meteo.com/v1/forecast?latitude=51.53&longitude=-0.12&current_weather=true"
              r = requests.get(url)
              if r.status_code != 200:
                  return {}
              data = r.json().get("current_weather", {})
              return {
                  "temp": data.get("temperature"),
                  "weather": data.get("weathercode"),
                  "wind": data.get("windspeed"),
                  "humidity": data.get("relative_humidity", "?"),
                  "feels_like": data.get("apparent_temperature", "?")
              }

          def fetch_places():
              api_key = os.getenv("GOOGLE_API_KEY")
              if not api_key:
                  return []
              url = f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=51.53,-0.12&radius=1200&type=restaurant&key={api_key}"
              r = requests.get(url)
              results = r.json().get("results", [])
              return [
                  {
                      "name": safe_get(p, "name"),
                      "rating": safe_get(p, "rating"),
                      "user_ratings_total": safe_get(p, "user_ratings_total"),
                      "address": safe_get(p, "vicinity"),
                      "type": (p.get("types") or ["restaurant"])[0]
                  } for p in results
              ]

          def fetch_events():
              token = os.getenv("EVENTBRITE_TOKEN")
              if not token:
                  return []
              url = "https://www.eventbriteapi.com/v3/events/search/"
              params = {
                  "q": "Kings Cross London",
                  "sort_by": "date",
                  "location.latitude": "51.53",
                  "location.longitude": "-0.12",
                  "location.within": "3km"
              }
              headers = {"Authorization": f"Bearer {token}"}
              r = requests.get(url, headers=headers, params=params)
              events = r.json().get("events", [])
              return [
                  {
                      "name": e.get("name", {}).get("text"),
                      "date": e.get("start", {}).get("local", ""),
                      "venue": e.get("venue_id", ""),
                      "description": e.get("summary", ""),
                      "link": e.get("url", "")
                  } for e in events
              ]

          # Fetch all sources
          weather = fetch_weather()
          places = fetch_places()
          events = fetch_events()

          data = {
              "updated": datetime.datetime.now().strftime("%Y-%m-%d %H:%M"),
              "weather": weather,
              "places": places,
              "events": events
          }

          # Save main JSON
          os.makedirs("dashboard_build/data", exist_ok=True)
          with open("dashboard_build/data/kingscross_dashboard.json", "w") as f:
              json.dump(data, f, indent=2)

          # Simple placeholder visualization
          plt.figure(figsize=(6,3))
          plt.title("Kings Cross Temperature Trend")
          plt.plot([15,16,15.5,14.8,15.3], marker="o")
          plt.ylabel("Â°C")
          plt.tight_layout()
          plt.savefig("dashboard_build/data/kingscross_dashboard.png")
          EOF

      - name: Prepare gh-pages branch
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          git pull origin gh-pages || true

      - name: Copy dashboard to gh-pages
        run: |
          mkdir -p data
          cp dashboard_build/data/* data/ || true
          cp index.html ./index.html || echo "index.html not found"

      - name: Commit and push
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git add -A
          git commit -m "Auto-update dashboard $(date)" || echo "No changes to commit"
          git push origin gh-pages