name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib pandas

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt, pandas as pd

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER DATA ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          LAT, LON = 51.5308, -0.1238
          r = requests.get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric")
          data = r.json()
          weather_info = {"temperature_C": data["main"]["temp"], "windspeed_kmh": data["wind"]["speed"], "weather_code": data["weather"][0]["id"]}

          # --- TFL DATA (ALL LINES) ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,tram,river-bus,train/Status?app_key={tfl_key}")
          tfl_data = tfl_r.json()
          tfl_filtered = [{"name": l["name"],"mode":l["modeName"],"status":l["lineStatuses"][0]["statusSeverityDescription"]} for l in tfl_data]

          # --- EVENTBRITE EVENTS ---
          EB_TOKEN = os.getenv("EVENTBRITE_TOKEN")
          eb_url = f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={EB_TOKEN}&sort_by=date"
          eb_r = requests.get(eb_url)
          eb_data = eb_r.json()
          events = []
          for e in eb_data.get("events", []):
              events.append({"name": e["name"]["text"], "start": e["start"]["local"], "url": e["url"]})
          with open("data/events.json","w") as f: json.dump(events,f,indent=2)

          # --- DASHBOARD JSON ---
          dashboard = {"timestamp": datetime.datetime.utcnow().isoformat()+"Z", "weather": weather_info, "tfl": tfl_filtered}
          with open("data/kingscross_dashboard.json","w") as f: json.dump(dashboard,f,indent=2)

          # --- HISTORY FOR LAST 24H ---
          history_path = "data/kingscross_history.json"
          history = []
          if os.path.exists(history_path):
              try:
                  with open(history_path) as f: history = json.load(f)
              except json.JSONDecodeError:
                  history = []
          history.append({"timestamp": dashboard["timestamp"], "temperature_C": dashboard["weather"]["temperature_C"], "tfl": dashboard["tfl"]})
          history = history[-24:]
          with open(history_path,"w") as f: json.dump(history,f,indent=2)

          # --- DASHBOARD IMAGE ---
          color_map = {"Good Service":"green","Minor Delays":"orange","Severe Delays":"red","Part Closure":"purple","Planned Closure":"gray","Service Closed":"black"}
          
          # TfL Status (circles)
          fig, ax = plt.subplots(figsize=(10,6))
          for i, line in enumerate(tfl_filtered):
              status = line['status']
              color = color_map.get(status, 'gray')
              ax.scatter(0, i, s=400, color=color, edgecolor='black', zorder=3)
              ax.text(0.1, i, f"{line['name']} ({status})", va='center', fontsize=10, weight='bold')
          ax.set_yticks([]); ax.set_xticks([])
          ax.set_xlim(-0.5, 2)
          ax.set_title("TfL Line Status at Kings Cross", fontsize=14)
          plt.tight_layout()
          plt.savefig("data/kingscross_tfl_improved.png")
          plt.close(fig)

          # Temperature chart
          fig, ax = plt.subplots(figsize=(10,6))
          timestamps = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in history]
          temps = [d["temperature_C"] for d in history]
          ax.plot(timestamps, temps, marker="o", color="blue")
          ax.scatter(timestamps[-1], temps[-1], color="red", s=100, label="Current Temp")
          ax.set_title("Kings Cross Temperature Trend (Last 24h)")
          ax.set_ylabel("¬∞C")
          ax.set_xticks(timestamps)
          ax.set_xticklabels([t.strftime("%H:%M") for t in timestamps], rotation=45)
          ax.grid(True)
          plt.tight_layout()
          plt.savefig("data/kingscross_temp_24h.png")
          plt.close(fig)
          EOF

      - name: Create web dashboard
        run: |
          cat > index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Kings Cross Live Dashboard</title>
            <style>
              body { font-family: Arial, sans-serif; text-align:center; background:#fafafa; padding:20px; }
              h1,h2,h3 { color:#333; }
              img { max-width:90%; margin-bottom:20px; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
              ul { list-style:none; padding:0; max-width:600px; margin:0 auto; text-align:left; }
              li { background:#fff; margin-bottom:8px; padding:12px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
              li a { text-decoration:none; color:#007bff; font-weight:600; }
              li a:hover { text-decoration:underline; }
              button { margin:20px 0; padding:10px 20px; font-size:1em; cursor:pointer; border-radius:8px; border:none; background-color:#007bff; color:#fff; }
              button:hover { background-color:#0056b3; }
            </style>
          </head>
          <body>
            <h1>üèôÔ∏è Kings Cross Live Dashboard</h1>
            <p>Updated automatically every hour</p>
            <button onclick="refreshPage()">üîÑ Refresh Now</button>

            <img id="tflImg" src="kingscross_tfl_improved.png" alt="TfL Line Status">
            <img id="tempImg" src="kingscross_temp_24h.png" alt="Temperature Last 24h">

            <h2>üé´ Upcoming Events in King‚Äôs Cross</h2>
            <h3>Today</h3>
            <ul id="eventToday">Loading...</ul>
            <h3>Later This Week</h3>
            <ul id="eventWeek">Loading...</ul>

            <footer style="margin-top:40px; font-size:0.85em; color:#777;">
              Data sources: OpenWeather, TfL, Eventbrite | Dashboard generated with Python & GitHub Actions
            </footer>

            <script>
              setTimeout(() => location.reload(), 3600000);
              function refreshPage() { location.reload(); }

              fetch('data/events.json')
                .then(r => r.json())
                .then(events => {
                  const now = new Date();
                  const ulToday = document.getElementById('eventToday');
                  const ulWeek = document.getElementById('eventWeek');
                  ulToday.innerHTML = ''; ulWeek.innerHTML = '';

                  events.forEach(ev => {
                    const evDate = new Date(ev.start);
                    const li = document.createElement('li');
                    li.innerHTML = `<a href="${ev.url}" target="_blank">${ev.name}</a> ‚Äî ${evDate.toLocaleString()}`;
                    if(evDate.toDateString() === now.toDateString()) ulToday.appendChild(li);
                    else ulWeek.appendChild(li);
                  });

                  if(!ulToday.hasChildNodes()) ulToday.innerHTML = '<li>No events today.</li>';
                  if(!ulWeek.hasChildNodes()) ulWeek.innerHTML = '<li>No upcoming events this week.</li>';
                })
                .catch(err => { console.error(err); });
            </script>
          </body>
          </html>
          HTML

      - name: Deploy to GitHub Pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          cp -r data/* .
          cp index.html .

          git add -A
          git commit -m "üöÄ Update dashboard + events [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force