name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib pandas

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
          PLACES_API_KEY: ${{ secrets.PLACES_API_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt, pandas as pd

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER ---
          wdata = requests.get(
              f"https://api.openweathermap.org/data/2.5/weather?lat=51.5308&lon=-0.1238&appid={os.getenv('OPENWEATHER_KEY')}&units=metric"
          ).json()
          weather_info = {"temperature_C": wdata["main"]["temp"], "windspeed_kmh": wdata["wind"]["speed"], "weather_code": wdata["weather"][0]["id"]}

          # --- TfL (all lines) ---
          tfl_data = requests.get(
              f"https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,elizabeth,river-bus/Status?app_key={os.getenv('TFL_APP_KEY')}"
          ).json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan","Great Northern","Thameslink","London Overground"}
          tfl_filtered = [{"name": l["name"], "mode": l["modeName"], "status": l["lineStatuses"][0]["statusSeverityDescription"]} for l in tfl_data if l["name"] in kings_cross_lines]

          # --- Eventbrite ---
          eb_data = requests.get(
              f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={os.getenv('EVENTBRITE_TOKEN')}&sort_by=date"
          ).json()
          events = [{"name": e["name"]["text"], "start": e["start"]["local"], "url": e["url"]} for e in eb_data.get("events", [])]
          with open("data/events.json","w") as f: json.dump(events,f,indent=2)

          # --- Google Places ---
          places_data = requests.get(
              f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=51.5308,-0.1238&radius=500&type=restaurant&key={os.getenv('PLACES_API_KEY')}"
          ).json()
          places = [{"name": p["name"], "rating": p.get("rating"), "user_ratings_total": p.get("user_ratings_total")} for p in places_data.get("results", [])]
          with open("data/places.json","w") as f: json.dump(places,f,indent=2)

          # --- Dashboard JSON & history ---
          dashboard = {"timestamp": datetime.datetime.utcnow().isoformat()+"Z","weather": weather_info,"tfl": tfl_filtered,"events": events,"places": places}
          with open("data/kingscross_dashboard.json","w") as f: json.dump(dashboard,f,indent=2)

          history_path = "data/kingscross_history.json"
          history = []
          if os.path.exists(history_path):
              try:
                  history = json.load(open(history_path))
              except: history = []
          history.append({"timestamp": dashboard["timestamp"], "temperature_C": weather_info["temperature_C"], "tfl": tfl_filtered})
          history = history[-24:]
          with open(history_path,"w") as f: json.dump(history,f,indent=2)

          # --- Dashboard images ---
          color_map = {"Good Service":"green","Minor Delays":"orange","Severe Delays":"red","Part Closure":"purple","Planned Closure":"gray","Service Closed":"black"}
          fig, (ax1, ax2) = plt.subplots(1,2,figsize=(12,5))
          timestamps = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in history]
          temps = [d["temperature_C"] for d in history]
          ax1.plot(timestamps, temps, marker="o", color="blue")
          ax1.set_title("Kings Cross Temperature Trend (¬∞C)")
          ax1.set_xlabel("Time (UTC)"); ax1.set_ylabel("Temperature ¬∞C"); ax1.grid(True)
          names = [line["name"] for line in tfl_filtered]
          statuses = [line["status"] for line in tfl_filtered]
          colors = [color_map.get(s,"gray") for s in statuses]
          ax2.barh(names,[1]*len(names),color=colors)
          for i,s in enumerate(statuses): ax2.text(0.02,i,s,va="center",ha="left",color="white",fontsize=10,fontweight="bold")
          ax2.set_xlim(0,1); ax2.set_xticks([]); ax2.set_title("TfL / Rail Line Status at Kings Cross")
          fig.text(0.5,0.01,datetime.datetime.utcnow().strftime("Updated: %d %b %Y, %H:%M UTC"),ha="center",fontsize=9,color="gray")
          plt.tight_layout(rect=[0,0.03,1,1])
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)
          EOF

      - name: Build web page
        run: |
          cat > index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head><meta charset="UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1.0">
          <title>Kings Cross Dashboard</title></head>
          <body>
          <h1>üèôÔ∏è Kings Cross Live Dashboard</h1>
          <img src="data/kingscross_dashboard.png" alt="Dashboard">
          <h2>Events</h2><ul id="events"></ul>
          <h2>Places</h2><ul id="places"></ul>
          <script>
          fetch('data/events.json').then(r=>r.json()).then(e=>{const ul=document.getElementById('events');e.forEach(ev=>{let li=document.createElement('li');li.innerHTML=`<a href="${ev.url}" target="_blank">${ev.name}</a> ‚Äî ${new Date(ev.start).toLocaleString()}`;ul.appendChild(li);})})
          fetch('data/places.json').then(r=>r.json()).then(p=>{const ul=document.getElementById('places');p.forEach(pl=>{let li=document.createElement('li');li.textContent=`${pl.name} ‚Äî Rating: ${pl.rating||'N/A'} (${pl.user_ratings_total||0} reviews)`;ul.appendChild(li);})})
          </script></body></html>
          HTML

      - name: Deploy to GitHub Pages (safe)
        run: |
          # Configure git
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Create temporary deployment folder
          DEPLOY_DIR=$(mktemp -d)
          cp -r index.html data/* "$DEPLOY_DIR/"

          # Push to gh-pages branch
          cd "$DEPLOY_DIR"
          git init
          git remote add origin https://github.com/${GITHUB_REPOSITORY}.git
          git checkout -b gh-pages
          git add -A
          git commit -m "üöÄ Auto-update dashboard [skip ci]"
          git push --force origin gh-pages
