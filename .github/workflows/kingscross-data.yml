name: Kings Cross Full Dashboard

on:
  schedule:
    - cron: '0 * * * *'  # every hour
  workflow_dispatch:

jobs:
  fetch-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas

      - name: Fetch TfL & National Rail data
        run: |
          python - <<'EOF'
          import requests
          import json
          from pathlib import Path

          BASE_URL = "https://api.tfl.gov.uk/Line/Mode"
          MODES = ["tube", "overground", "dlr", "tflrail", "national-rail"]
          DATA_PATH = Path("data/kingscross_tfl.json")

          all_lines_status = []

          for mode in MODES:
              try:
                  url = f"{BASE_URL}/{mode}/Status"
                  resp = requests.get(url)
                  resp.raise_for_status()
                  lines_data = resp.json()

                  for l in lines_data:
                      if isinstance(l, dict):
                          name = l.get("name", "Unknown")
                          status_entries = l.get("lineStatuses", [])
                          status = status_entries[0].get("statusSeverityDescription", "Unknown") if status_entries else "Unknown"
                          all_lines_status.append({"name": name, "mode": mode, "status": status})
              except Exception as e:
                  print(f"Error fetching {mode}: {e}")

          DATA_PATH.parent.mkdir(parents=True, exist_ok=True)
          with open(DATA_PATH, "w") as f:
              json.dump(all_lines_status, f, indent=2)
          print(f"TfL & Rail status saved to {DATA_PATH}")
          EOF

      - name: Generate Dashboard
        run: |
          python - <<'EOF'
          import json
          from pathlib import Path

          TFL_PATH = Path("data/kingscross_tfl.json")
          DASHBOARD_PATH = Path("data/kingscross_dashboard.json")

          if TFL_PATH.exists():
              with open(TFL_PATH) as f:
                  tfl_data = json.load(f)

              dashboard = {
                  "lines": tfl_data,
                  "summary": f"{len(tfl_data)} lines fetched"
              }

              DASHBOARD_PATH.parent.mkdir(parents=True, exist_ok=True)
              with open(DASHBOARD_PATH, "w") as f:
                  json.dump(dashboard, f, indent=2)

              print(f"Dashboard saved to {DASHBOARD_PATH}")
          else:
              print("TfL data file not found, skipping dashboard generation.")
          EOF

      - name: Commit & push data to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin gh-pages
          git checkout gh-pages || git checkout -b gh-pages
          git add data/kingscross_tfl.json data/kingscross_dashboard.json
          git commit -m "ðŸš€ Update dashboard + TfL/Rail status [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force