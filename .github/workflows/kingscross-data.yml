name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER DATA ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          if not API_KEY: raise Exception("‚ùå OPENWEATHER_KEY missing")
          LAT, LON = 51.5308, -0.1238
          r = requests.get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric")
          data = r.json()
          if "main" not in data: raise Exception(f"‚ùå OpenWeather API error: {data}")
          weather_info = {"temperature_C": data["main"]["temp"], "windspeed_kmh": data["wind"]["speed"], "weather_code": data["weather"][0]["id"]}

          # --- TFL DATA ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/tube/Status?app_key={tfl_key}")
          tfl_data = tfl_r.json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan"}
          tfl_filtered = [{"name": l["name"],"mode":l["modeName"],"status":l["lineStatuses"][0]["statusSeverityDescription"]} for l in tfl_data if l["name"] in kings_cross_lines]

          # --- MERGE DATA ---
          dashboard = {"timestamp": datetime.datetime.utcnow().isoformat()+"Z", "weather": weather_info, "tfl": tfl_filtered}
          with open("data/kingscross_dashboard.json","w") as f: json.dump(dashboard,f,indent=2)

          # --- HISTORY (with JSON safeguard) ---
          history_path = "data/kingscross_history.json"
          history = []
          if os.path.exists(history_path):
              try:
                  with open(history_path) as f:
                      history = json.load(f)
              except json.JSONDecodeError:
                  print("‚ö†Ô∏è Malformed history JSON detected ‚Äî resetting history.")
                  history = []

          history.append({"timestamp": dashboard["timestamp"], "temperature_C": dashboard["weather"]["temperature_C"], "tfl": dashboard["tfl"]})
          with open(history_path,"w") as f: json.dump(history,f,indent=2)

          # --- DASHBOARD IMAGE ---
          color_map = {"Good Service":"green","Minor Delays":"orange","Severe Delays":"red","Part Closure":"purple","Planned Closure":"gray","Service Closed":"black"}
          fig, (ax1, ax2) = plt.subplots(1,2,figsize=(12,5))
          timestamps = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in history]
          temps = [d["temperature_C"] for d in history]
          ax1.plot(timestamps, temps, marker="o", color="blue")
          ax1.set_title("Kings Cross Temperature Trend (¬∞C)")
          ax1.set_xlabel("Time (UTC)"); ax1.set_ylabel("Temperature ¬∞C"); ax1.grid(True)

          names = [line["name"] for line in tfl_filtered]
          statuses = [line["status"] for line in tfl_filtered]
          colors = [color_map.get(s,"gray") for s in statuses]
          ax2.barh(names,[1]*len(names),color=colors)
          for i,s in enumerate(statuses): ax2.text(0.02,i,s,va="center",ha="left",color="white",fontsize=10,fontweight="bold")
          ax2.set_xlim(0,1); ax2.set_xticks([]); ax2.set_title("TfL Line Status at Kings Cross")
          fig.text(0.5,0.01,datetime.datetime.utcnow().strftime("Updated: %d %b %Y, %H:%M UTC"),ha="center",fontsize=9,color="gray")
          plt.tight_layout(rect=[0,0.03,1,1])
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)

          # --- 24h Temp + TfL Chart ---
          history_last_24 = history[-24:]
          timestamps_24 = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in history_last_24]
          temps_24 = [d["temperature_C"] for d in history_last_24]
          lines = ["Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan"]
          line_colors = {line: [] for line in lines}
          for entry in history_last_24:
              tfl_dict = {l["name"]: l["status"] for l in entry.get("tfl",[])}
              for line in lines: line_colors[line].append(color_map.get(tfl_dict.get(line,"Unknown"),"gray"))
          cold_threshold = 5
          hot_threshold = 25
          fig, ax = plt.subplots(figsize=(10,6))
          ax.plot(timestamps_24, temps_24, marker="o", color='blue', label="Temperature ¬∞C")
          ax.set_title("Kings Cross Last 24h: Temp + TfL Status")
          ax.set_ylabel("Temperature (¬∞C)")
          ax.set_xticks(timestamps_24)
          ax.set_xticklabels([t.strftime("%H:%M") for t in timestamps_24], rotation=45)
          for i, t in enumerate(timestamps_24[:-1]):
              next_t = timestamps_24[i+1]; temp = temps_24[i]
              if temp <= cold_threshold: ax.axvspan(t, next_t, color='lightblue', alpha=0.3)
              elif temp >= hot_threshold: ax.axvspan(t, next_t, color='salmon', alpha=0.3)
          bar_height = 0.3
          for i,line in enumerate(lines):
              for j,t in enumerate(timestamps_24):
                  ax.bar(t, bar_height, bottom=min(temps_24)-2-(i*0.5), width=0.03, color=line_colors[line])
          import matplotlib.patches as mpatches
          legend_patches = [mpatches.Patch(color=c,label=l) for l,c in color_map.items()]
          ax.legend(handles=legend_patches+[mpatches.Patch(color="blue",label="Temperature ¬∞C"),
                                           mpatches.Patch(color='lightblue', alpha=0.3, label='Cold ‚â§5¬∞C'),
                                           mpatches.Patch(color='salmon', alpha=0.3, label='Hot ‚â•25¬∞C')],
                    loc="upper left", bbox_to_anchor=(1,1))
          plt.tight_layout()
          plt.savefig("data/kingscross_temp_24h_tfl.png")
          plt.close(fig)
          EOF

      - name: Create web dashboard
        run: |
          cat > index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Kings Cross Live Dashboard</title>
            <style>
              body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 40px; }
              h1,h2 { color:#333; }
              img { max-width:90%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
              button { margin:10px 0; padding:8px 16px; cursor:pointer; border-radius:6px; background:#007bff; color:#fff; border:none; }
              pre { text-align:left; background:#f4f4f4; padding:10px; border-radius:8px; overflow-x:auto; max-height:400px; }
              .hidden{display:none;}
            </style>
          </head>
          <body>
            <h1>üèôÔ∏è Kings Cross Live Dashboard</h1>
            <p>Updated automatically every hour</p>
            <img src="kingscross_dashboard.png" alt="Current Dashboard" id="dashboard_img">
            <img src="kingscross_temp_24h_tfl.png" alt="Last 24h Temperature + TfL Chart" id="chart_img">
            <h2>üìÑ Last 24h Temperature Data</h2>
            <button onclick="document.getElementById('jsonData').classList.toggle('hidden')">Show / Hide JSON</button>
            <pre id="jsonData" class="hidden"></pre>
