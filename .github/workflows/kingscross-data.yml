name: üèôÔ∏è Kings Cross Full Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib pandas jinja2

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          MEETUP_KEY: ${{ secrets.MEETUP_KEY }}
          TICKETMASTER_KEY: ${{ secrets.TICKETMASTER_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib
          import matplotlib.pyplot as plt
          import pandas as pd
          from collections import Counter
          from jinja2 import Template

          pathlib.Path("data").mkdir(exist_ok=True)

          LAT, LON = 51.5308, -0.1238

          # --- WEATHER ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          r = requests.get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric")
          data = r.json()
          weather_info = {"temperature_C": data.get("main",{}).get("temp",0),
                          "windspeed_kmh": data.get("wind",{}).get("speed",0),
                          "weather_code": data.get("weather",[{}])[0].get("id",0)}

          # --- TFL/RAIL STATUS (all lines) ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,tram,river-bus,coach,rail/Status?app_key={tfl_key}")
          tfl_data = tfl_r.json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan"}
          tfl_filtered = []
          for l in tfl_data:
              if isinstance(l, dict) and l.get("name") in kings_cross_lines:
                  status = l.get("lineStatuses",[{}])[0].get("statusSeverityDescription","Unknown")
                  tfl_filtered.append({"name": l.get("name"),"mode":l.get("modeName"),"status":status})

          # --- EVENTS ---
          events = []

          # Eventbrite
          EB_TOKEN = os.getenv("EVENTBRITE_TOKEN")
          eb_url = f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={EB_TOKEN}&sort_by=date"
          eb_data = requests.get(eb_url).json()
          for e in eb_data.get("events", []):
              if isinstance(e, dict) and "name" in e and "text" in e["name"]:
                  events.append({"name": e["name"]["text"], "start": e.get("start",{}).get("local",""), "url": e.get("url","")})

          # Google Places
          GOOGLE_KEY = os.getenv("GOOGLE_API_KEY")
          g_url = f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location={LAT},{LON}&radius=1000&type=establishment&keyword=event&key={GOOGLE_KEY}"
          g_data = requests.get(g_url).json()
          for place in g_data.get("results", []):
              if isinstance(place, dict):
                  events.append({"name": place.get("name",""), "start": "", "url": f"https://www.google.com/maps/place/?q=place_id:{place.get('place_id','')}"})

          # Meetup
          MEETUP_KEY = os.getenv("MEETUP_KEY")
          meetup_data = requests.get(f"https://api.meetup.com/find/upcoming_events?&lat={LAT}&lon={LON}&radius=1&key={MEETUP_KEY}").json()
          for e in meetup_data.get("events", []):
              if isinstance(e, dict):
                  start_time = datetime.datetime.fromtimestamp(e.get("time",0)/1000).isoformat()
                  events.append({"name": e.get("name",""), "start": start_time, "url": e.get("link","")})

          # Ticketmaster
          TM_KEY = os.getenv("TICKETMASTER_KEY")
          tm_data = requests.get(f"https://app.ticketmaster.com/discovery/v2/events.json?apikey={TM_KEY}&latlong={LAT},{LON}&radius=1&unit=miles&locale=*").json()
          for e in tm_data.get("_embedded", {}).get("events", []):
              if isinstance(e, dict):
                  start_time = e.get("dates",{}).get("start",{}).get("dateTime","")
                  url = e.get("url","")
                  events.append({"name": e.get("name",""), "start": start_time, "url": url})

          # Deduplicate events
          seen = set()
          dedup_events = []
          for ev in events:
              key = (ev["name"], ev.get("start",""))
              if key not in seen:
                  dedup_events.append(ev)
                  seen.add(key)
          events = dedup_events

          # --- Save events JSON ---
          with open("data/events.json","w") as f: json.dump(events,f,indent=2)

          # --- Dashboard JSON ---
          dashboard = {"timestamp": datetime.datetime.utcnow().isoformat()+"Z", "weather": weather_info, "tfl": tfl_filtered}
          with open("data/kingscross_dashboard.json","w") as f: json.dump(dashboard,f,indent=2)

          # --- History ---
          history_path = "data/kingscross_history.json"
          history = []
          if os.path.exists(history_path):
              try: history = json.load(open(history_path))
              except: history = []
          history.append({"timestamp": dashboard["timestamp"], "temperature_C": dashboard["weather"]["temperature_C"], "tfl": dashboard["tfl"]})
          history = history[-24:]
          with open(history_path,"w") as f: json.dump(history,f,indent=2)

          # --- Dashboard Image ---
          fig, (ax1, ax2, ax3) = plt.subplots(3, 1, figsize=(12,12))
          timestamps = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in history]
          temps = [d["temperature_C"] for d in history]
          ax1.plot(timestamps, temps, marker="o", color="blue")
          ax1.set_title("Temperature Trend (¬∞C) ‚Äì Last 24h")
          ax1.set_ylabel("¬∞C")
          ax1.grid(True)
          ax1.xaxis.set_major_formatter(plt.matplotlib.dates.DateFormatter('%H:%M'))

          disruptions_counts = [sum(1 for l in d["tfl"] if l.get("status") not in ["Good Service"]) for d in history]
          ax2.plot(timestamps, disruptions_counts, marker="o", color="red")
          ax2.set_title("TfL Line Disruptions ‚Äì Last 24h")
          ax2.set_ylabel("# Lines")
          ax2.grid(True)
          ax2.xaxis.set_major_formatter(plt.matplotlib.dates.DateFormatter('%H:%M'))

          event_times = []
          for ev in events:
              try: dt = datetime.datetime.fromisoformat(ev["start"]); event_times.append(dt)
              except: pass
          hours_counter = Counter(dt.replace(minute=0, second=0, microsecond=0) for dt in event_times)
          event_counts = [hours_counter.get(ts.replace(minute=0, second=0, microsecond=0), 0) for ts in timestamps]
          ax3.bar(timestamps, event_counts, width=0.03, color="green")
          ax3.set_title("Events Per Hour ‚Äì Last 24h")
          ax3.set_ylabel("# Events")
          ax3.grid(True)
          ax3.xaxis.set_major_formatter(plt.matplotlib.dates.DateFormatter('%H:%M'))

          fig.tight_layout()
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)

          # --- Improved HTML dashboard (top 5 events + line disruptions) ---
          template = Template("""
          <html>
          <head><title>Kings Cross Dashboard</title></head>
          <body>
          <h1>Kings Cross Dashboard</h1>
          <h2>Weather: {{ weather.temperature_C }} ¬∞C, Wind: {{ weather.windspeed_kmh }} km/h</h2>
          <h2>Top 5 Upcoming Events</h2>
          <ul>
          {% for e in top_events %}
            <li><a href="{{ e.url }}">{{ e.name }}</a> - {{ e.start }}</li>
          {% endfor %}
          </ul>
          <h2>Line Disruptions</h2>
          <ul>
          {% for l in tfl %}
            {% if l.status != "Good Service" %}
              <li>{{ l.name }}: {{ l.status }}</li>
            {% endif %}
          {% endfor %}
          </ul>
          <img src="data/kingscross_dashboard.png" alt="Dashboard Plot">
          </body>
          </html>
          """)
          top_events = sorted([e for e in events if e.get("start")], key=lambda x: x["start"])[:5]
          with open("index.html","w") as f: f.write(template.render(weather=weather_info, top_events=top_events, tfl=tfl_filtered))
          EOF

      - name: Deploy to GitHub Pages safely
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          git reset --hard
          cp -r data/* .
          cp index.html .
          git add -A
          git commit -m "üöÄ Update dashboard + top events + line disruptions [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force
