name: üèôÔ∏è Kings Cross All-in-One Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib pandas

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
          MEETUP_TOKEN: ${{ secrets.MEETUP_TOKEN }}
          TICKETMASTER_KEY: ${{ secrets.TICKETMASTER_KEY }}
          GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib
          import matplotlib.pyplot as plt
          from matplotlib.gridspec import GridSpec

          pathlib.Path("data").mkdir(exist_ok=True)

          LAT, LON = 51.5308, -0.1238

          # --- WEATHER ---
          r = requests.get(f"https://api.openweathermap.org/data/2.5/onecall?lat={LAT}&lon={LON}&appid={os.getenv('OPENWEATHER_KEY')}&units=metric")
          weather = r.json()
          with open("data/kingscross_weather.json","w") as f: json.dump(weather,f,indent=2)

          # --- TFL ---
          tfl_r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,tram,river-bus/Status?app_key={os.getenv('TFL_APP_KEY')}")
          tfl_data = tfl_r.json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan","Overground","DLR"}
          tfl_filtered = []
          for l in tfl_data:
              if l.get("name") in kings_cross_lines:
                  status = l.get("lineStatuses",[{}])[0].get("statusSeverityDescription","Unknown")
                  tfl_filtered.append({"name": l["name"], "status": status})
          with open("data/kingscross_tfl.json","w") as f: json.dump(tfl_filtered,f,indent=2)

          # --- EVENTBRITE ---
          eb_r = requests.get(f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={os.getenv('EVENTBRITE_TOKEN')}&sort_by=date")
          eb_data = eb_r.json()
          events = [{"name": e["name"]["text"], "start": e["start"]["local"], "url": e["url"]} for e in eb_data.get("events", [])]

          # --- MEETUP ---
          meetup_r = requests.get(f"https://api.meetup.com/find/upcoming_events?&lat={LAT}&lon={LON}&radius=2&key={os.getenv('MEETUP_TOKEN')}")
          meetup_data = meetup_r.json()
          meetup_events = []
          for e in meetup_data.get("events", []):
              meetup_events.append({
                  "name": e.get("name",""),
                  "start": e.get("local_date","") + " " + e.get("local_time",""),
                  "url": e.get("link","")
              })
          events.extend(meetup_events)

          # --- TICKETMASTER ---
          tm_r = requests.get(f"https://app.ticketmaster.com/discovery/v2/events.json?apikey={os.getenv('TICKETMASTER_KEY')}&latlong={LAT},{LON}&radius=2&unit=miles")
          tm_data = tm_r.json()
          tm_events = []
          for e in tm_data.get("_embedded", {}).get("events", []):
              tm_events.append({
                  "name": e.get("name",""),
                  "start": e.get("dates", {}).get("start", {}).get("dateTime",""),
                  "url": e.get("url","")
              })
          events.extend(tm_events)

          with open("data/events.json","w") as f: json.dump(events,f,indent=2)

          # --- GOOGLE PLACES ---
          places_r = requests.get(f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location={LAT},{LON}&radius=1000&type=restaurant&key={os.getenv('GOOGLE_PLACES_KEY')}")
          places_data = places_r.json()
          places = [{"name": p["name"], "address": p.get("vicinity","")} for p in places_data.get("results",[])]
          with open("data/places.json","w") as f: json.dump(places,f,indent=2)

          # --- DASHBOARD IMAGE ---
          fig = plt.figure(figsize=(14,10))
          gs = GridSpec(4,2,figure=fig)

          ax1 = fig.add_subplot(gs[0,:])
          ax1.axis('off')
          status_lines = [f"{l['name']}: {l['status']}" for l in tfl_filtered]
          ax1.text(0,1,"\n".join(status_lines), fontsize=14, va='top', family='monospace')

          ax2 = fig.add_subplot(gs[1,0])
          temps = [h['temp'] for h in weather.get('hourly',[])[-24:]]
          ax2.plot(range(len(temps)), temps, color='tab:blue', linewidth=2)
          ax2.fill_between(range(len(temps)), temps, min(temps)-2, color='tab:blue', alpha=0.2)
          ax2.set_title('Last 24h Temp (¬∞C)')
          ax2.set_xticks([])

          ax3 = fig.add_subplot(gs[1,1])
          ax3.axis('off')
          top_events = events[:5] if events else []
          event_lines = [f"{ev['name']} ({ev['start']})" for ev in top_events]
          ax3.text(0,1,"\n".join(event_lines) if event_lines else "No upcoming events", fontsize=12, va='top')

          ax4 = fig.add_subplot(gs[2:,0:])
          ax4.axis('off')
          top_places = places[:8]
          place_lines = [f"{p['name']} ‚Äî {p['address']}" for p in top_places]
          ax4.text(0,1,"\n".join(place_lines), fontsize=12, va='top')

          plt.tight_layout()
          plt.savefig("data/kingscross_dashboard.png", dpi=150)
          plt.close()
          EOF

      - name: Create web dashboard
        run: |
          cat > index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head>
            <meta charset="UTF-8">
            <meta name="viewport" content="width=device-width, initial-scale=1.0">
            <title>Kings Cross Live Dashboard</title>
            <style>
              body { font-family: Arial, sans-serif; text-align: center; background: #fafafa; padding: 40px; }
              h1,h2 { color:#333; }
              img { max-width:90%; border-radius:12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); margin-bottom:20px; }
              ul { list-style-type:none; padding:0; max-width:600px; margin:0 auto; text-align:left; }
              li { background:#fff; margin-bottom:8px; padding:12px 16px; border-radius:8px; box-shadow:0 2px 6px rgba(0,0,0,0.05);}
              li a { text-decoration:none; color:#007bff; font-weight:600; }
              li a:hover { text-decoration:underline; }
              button { margin: 20px 0; padding: 10px 20px; font-size: 1em; cursor: pointer; border-radius:8px; border:none; background-color:#007bff; color:#fff; }
              button:hover { background-color:#0056b3; }
            </style>
          </head>
          <body>
            <h1>üèôÔ∏è Kings Cross Live Dashboard</h1>
            <p>Updated automatically every hour</p>
            <button onclick="refreshPage()">üîÑ Refresh Now</button>
            <img src="data/kingscross_dashboard.png" alt="Dashboard">
            <h2>üé´ Upcoming Events</h2>
            <ul id="eventList">Loading events...</ul>
            <h2>üç¥ Nearby Restaurants</h2>
            <ul id="placesList">Loading places...</ul>
            <footer style="margin-top:40px; font-size:0.85em; color:#777;">
              Data sources: OpenWeather, TfL, Eventbrite, Meetup, Ticketmaster, Google Places
            </footer>
            <script>
              setTimeout(() => location.reload(), 3600000);
              function refreshPage() { location.reload(); }

              fetch('data/events.json').then(r=>r.json()).then(events=>{
                const ul = document.getElementById('eventList'); ul.innerHTML='';
                if(events.length===0){ ul.innerHTML='<li>No upcoming events found.</li>'; }
                events.slice(0,10).forEach(ev=>{
                  const li=document.createElement('li');
                  li.innerHTML=`<a href="${ev.url}" target="_blank">${ev.name}</a> ‚Äî ${new Date(ev.start).toLocaleString()}`;
                  ul.appendChild(li);
                });
              }).catch(err=>{ document.getElementById('eventList').innerHTML='<li>Error loading events.</li>'; console.error(err); });

              fetch('data/places.json').then(r=>r.json()).then(places=>{
                const ul = document.getElementById('placesList'); ul.innerHTML='';
                if(places.length===0){ ul.innerHTML='<li>No places found.</li>'; }
                places.slice(0,10).forEach(p=>{
                  const li=document.createElement('li');
                  li.textContent = `${p.name} ‚Äî ${p.address}`;
                  ul.appendChild(li);
                });
              }).catch(err=>{ document.getElementById('placesList').innerHTML='<li>Error loading places.</li>'; console.error(err); });
            </script>
          </body>
          </html>
          HTML

      - name: Deploy to GitHub Pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin gh-pages || true
          git checkout -B gh-pages
          cp -r data/* .
          cp index.html .
          git add -A
          git commit -m "üöÄ Update full dashboard with all events [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force