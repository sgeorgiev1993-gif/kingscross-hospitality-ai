name: üß† Kings Cross AI Dashboard

on:
  schedule:
    - cron: "0 */3 * * *" # Every 3 hours
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: üßæ Checkout repository
        uses: actions/checkout@v4

      - name: üêç Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: üì¶ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas matplotlib requests pytz

      - name: üì° Fetch Data & Generate Dashboard
        env:
          GOOGLE_PLACES_API_KEY: ${{ secrets.GOOGLE_PLACES_API_KEY }}
        run: |
          import json, requests, datetime, pytz, os, matplotlib.pyplot as plt

          os.makedirs("data", exist_ok=True)

          def safe_json(resp):
              try:
                  return resp.json()
              except Exception:
                  return []

          # --- Fetch weather data ---
          weather = safe_json(requests.get("https://api.met.no/weatherapi/locationforecast/2.0/compact?lat=51.5308&lon=-0.1238"))
          timeseries = weather.get("properties", {}).get("timeseries", [])[:24]
          temps = [
              {"timestamp": t["time"], "temperature_C": t.get("data", {}).get("instant", {}).get("details", {}).get("air_temperature", None)}
              for t in timeseries if t.get("data")
          ]
          json.dump(temps, open("data/kingscross_history.json", "w"), indent=2)

          # --- Fetch TfL + Rail status ---
          tfl = safe_json(requests.get("https://api.tfl.gov.uk/Line/Mode/tube,overground,elizabeth-line,dlr,national-rail/Status"))
          tfl_filtered = []
          for line in tfl:
              if isinstance(line, dict):
                  name = line.get("name")
                  status = ""
                  if line.get("lineStatuses"):
                      status = line["lineStatuses"][0].get("statusSeverityDescription", "")
                  tfl_filtered.append({"name": name, "status": status})
          json.dump(tfl_filtered, open("data/tfl_status.json", "w"), indent=2)

          # --- Fetch nearby places from Google Places ---
          key = os.environ.get("GOOGLE_PLACES_API_KEY")
          places = []
          if key:
              place_types = ["restaurant", "cafe", "bar"]
              for ptype in place_types:
                  r = requests.get(
                      f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location=51.5308,-0.1238&radius=800&type={ptype}&key={key}"
                  )
                  j = safe_json(r)
                  for result in j.get("results", []):
                      places.append({
                          "name": result.get("name"),
                          "type": ptype,
                          "rating": result.get("rating"),
                          "address": result.get("vicinity")
                      })
              json.dump(places, open("data/places.json", "w"), indent=2)

          # --- Generate dashboard image ---
          color_map = {
              "Good Service": "green",
              "Minor Delays": "orange",
              "Severe Delays": "red",
              "Part Closure": "purple",
              "Planned Closure": "gray",
              "Service Closed": "black"
          }

          fig, axes = plt.subplots(1, 3, figsize=(18,5))

          # Panel 1: Temperature
          timestamps = [datetime.datetime.fromisoformat(d["timestamp"].replace("Z","")) for d in temps]
          values = [d["temperature_C"] for d in temps]
          axes[0].plot(timestamps, values, color="blue", marker="o")
          axes[0].set_title("Kings Cross Temperature (24h)")
          axes[0].set_xlabel("Time (UTC)")
          axes[0].set_ylabel("¬∞C")
          axes[0].grid(True)

          # Panel 2: TfL + Rail
          names = [l["name"] for l in tfl_filtered]
          statuses = [l["status"] for l in tfl_filtered]
          colors = [color_map.get(s, "gray") for s in statuses]
          axes[1].barh(names, [1]*len(names), color=colors)
          for i, s in enumerate(statuses):
              axes[1].text(0.02, i, s, va="center", ha="left", color="white", fontsize=9, fontweight="bold")
          axes[1].set_xlim(0,1)
          axes[1].set_xticks([])
          axes[1].set_title("TfL + Rail Status")

          # Panel 3: Places
          place_types = ["restaurant","cafe","bar"]
          counts = [sum(1 for p in places if p["type"]==t) for t in place_types]
          axes[2].bar(place_types, counts, color=["#FF6347","#6A5ACD","#3CB371"])
          axes[2].set_title("Nearby Places by Type")
          axes[2].set_ylabel("Count")

          plt.tight_layout()
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)

          # --- Dashboard summary JSON ---
          summary = {
              "timestamp": datetime.datetime.utcnow().isoformat(),
              "latest_temp": values[-1] if values else None,
              "disrupted_lines": [l["name"] for l in tfl_filtered if l["status"] != "Good Service"],
              "places_summary": {t: c for t,c in zip(place_types, counts)}
          }
          json.dump(summary, open("data/kingscross_dashboard.json", "w"), indent=2)
        shell: python

      - name: üöÄ Deploy to gh-pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin gh-pages || echo "No gh-pages branch yet"
          git stash || true
          git checkout gh-pages || git checkout --orphan gh-pages
          git rm -rf . || true
          git checkout main -- index.html data || true
          git add data index.html || true
          git commit -m "üîÅ Auto-update Kings Cross Dashboard" || echo "No changes to commit"
          git push origin gh-pages --force