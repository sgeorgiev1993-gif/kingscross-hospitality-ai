name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          set -e
          echo "üöÄ Starting data fetch..."
          python <<'PYCODE'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt

          pathlib.Path("data").mkdir(exist_ok=True)

          def safe_get(url, headers=None):
              r = requests.get(url, headers=headers)
              print(f"üîó GET {url} -> {r.status_code}")
              try:
                  return r.json()
              except Exception:
                  print("‚ö†Ô∏è Could not decode JSON response.")
                  return {}

          # WEATHER
          print("üå¶Ô∏è Fetching OpenWeather data...")
          OW = os.getenv("OPENWEATHER_KEY")
          LAT, LON = 51.5308, -0.1238
          w = safe_get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={OW}&units=metric")
          weather_info = {"temperature_C": w.get("main", {}).get("temp"), "condition": w.get("weather", [{}])[0].get("description", "unknown")}

          # TFL + RAIL
          print("üöá Fetching TfL data...")
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_data = safe_get(f"https://api.tfl.gov.uk/Line/Mode/tube,dlr,overground,national-rail/Status?app_key={tfl_key}")
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan","Thameslink"}
          tfl_filtered = [{"name": l["name"], "status": l["lineStatuses"][0]["statusSeverityDescription"]} for l in tfl_data if l["name"] in kings_cross_lines]

          # EVENTBRITE
          print("üéüÔ∏è Fetching Eventbrite events...")
          EB = os.getenv("EVENTBRITE_TOKEN")
          eb_url = "https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&location.within=2km&sort_by=date"
          eb_data = safe_get(eb_url, headers={"Authorization": f"Bearer {EB}"})
          events = []
          for e in eb_data.get("events", []):
              if e.get("name", {}).get("text"):
                  events.append({
                      "name": e["name"]["text"],
                      "start": e.get("start", {}).get("local"),
                      "url": e.get("url")
                  })

          print(f"üì¶ {len(events)} events fetched from Eventbrite.")
          with open("data/events.json", "w") as f:
              json.dump(events, f, indent=2)
          print("‚úÖ Saved data/events.json")

          # DASHBOARD
          dashboard = {
              "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
              "weather": weather_info,
              "tfl": tfl_filtered,
          }
          with open("data/kingscross_dashboard.json", "w") as f:
              json.dump(dashboard, f, indent=2)

          # GRAPH
          fig, ax = plt.subplots(figsize=(6, 4))
          names = [x["name"] for x in tfl_filtered]
          colors = ["green" if "Good" in x["status"] else "orange" if "Minor" in x["status"] else "red" for x in tfl_filtered]
          ax.barh(names, [1]*len(names), color=colors)
          for i, x in enumerate(tfl_filtered):
              ax.text(0.02, i, x["status"], va="center", ha="left", color="white")
          ax.set_xticks([]); ax.set_yticks([])
          ax.set_title("TfL + Rail Status")
          plt.tight_layout()
          plt.savefig("data/kingscross_dashboard.png")
          plt.close()
          print("‚úÖ Dashboard image saved.")
          PYCODE

      - name: Deploy to GitHub Pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages
          cp -r data/* .
          cp index.html || true
          git add -A
          git commit -m "üöÄ Update dashboard + events [skip ci]" || echo "No changes"
          git push origin gh-pages --force
