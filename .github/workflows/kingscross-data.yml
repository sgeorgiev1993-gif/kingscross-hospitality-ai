name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  fetch-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib pandas

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          LAT, LON = 51.5308, -0.1238
          w = requests.get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric").json()
          weather = {"temperature_C": w["main"]["temp"], "windspeed_kmh": w["wind"]["speed"], "weather_code": w["weather"][0]["id"]}

          # --- TFL (ALL LINES) ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl = requests.get(f"https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,tram,river-bus,coach/Status?app_key={tfl_key}").json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan","Great Northern","Thameslink","EMR","LNER"}
          tfl_filtered = []
          for l in tfl:
              if l.get("name") in kings_cross_lines:
                  status = l.get("lineStatuses",[{}])[0].get("statusSeverityDescription","Unknown")
                  tfl_filtered.append({"name": l["name"], "mode": l.get("modeName","Unknown"), "status": status})

          # --- EVENTBRITE ---
          EB = os.getenv("EVENTBRITE_TOKEN")
          eb = requests.get(f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={EB}&sort_by=date").json()
          events = []
          for e in eb.get("events", []):
              name = e.get("name", {}).get("text") if isinstance(e.get("name"), dict) else None
              start = e.get("start", {}).get("local") if isinstance(e.get("start"), dict) else None
              url = e.get("url")
              if name and start and url:
                  events.append({"name": name, "start": start, "url": url})

          with open("data/events.json","w") as f: json.dump(events,f,indent=2)
          with open("data/kingscross_dashboard.json","w") as f: json.dump({"timestamp": datetime.datetime.utcnow().isoformat()+"Z","weather":weather,"tfl":tfl_filtered},f,indent=2)

          # --- DASHBOARD IMAGE ---
          fig, (ax1,ax2) = plt.subplots(1,2,figsize=(12,5))
          ax1.plot([0,1],[weather["temperature_C"],weather["temperature_C"]], marker="o", color="blue")
          ax1.set_title("Temperature")
          names = [l["name"] for l in tfl_filtered]
          statuses = [l["status"] for l in tfl_filtered]
          colors = ["green" if s=="Good Service" else "red" for s in statuses]
          ax2.barh(names,[1]*len(names),color=colors)
          plt.tight_layout()
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)
          EOF

      - name: Create web dashboard
        run: |
          cat > index.html <<'HTML'
          <!DOCTYPE html>
          <html lang="en">
          <head><meta charset="UTF-8"><title>Kings Cross Dashboard</title></head>
          <body>
          <h1>Dashboard</h1>
          <img src="kingscross_dashboard.png" alt="Dashboard">
          <ul id="eventList">Loading...</ul>
          <script>
          fetch('data/events.json')
            .then(r=>r.json())
            .then(events=>{
              const ul=document.getElementById('eventList'); ul.innerHTML='';
              if(events.length===0){ ul.innerHTML='<li>No upcoming events</li>'; return; }
              events.forEach(ev=>{const li=document.createElement('li'); li.innerHTML=`<a href="${ev.url}">${ev.name}</a>`; ul.appendChild(li); });
            });
          </script>
          </body>
          </html>
          HTML

      - name: Deploy to GitHub Pages safely
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          # initialize gh-pages worktree in temp folder
          git fetch origin gh-pages || true
          mkdir -p /tmp/gh-pages
          git worktree add -B gh-pages /tmp/gh-pages origin/gh-pages
          # copy files to worktree
          cp -r data/* /tmp/gh-pages/
          cp index.html /tmp/gh-pages/
          cd /tmp/gh-pages
          git add -A
          git commit -m "üöÄ Update dashboard + events [skip ci]" || echo "No changes"
          git push origin gh-pages --force
