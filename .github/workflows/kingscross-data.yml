name: üèôÔ∏è Kings Cross Data Logger

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # runs every hour

jobs:
  fetch-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: pip install requests matplotlib

      - name: Fetch and generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
        run: |
          python - <<'EOF'
          import os, requests, json, datetime, pathlib, matplotlib.pyplot as plt

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER DATA ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          if not API_KEY:
              raise Exception("‚ùå OPENWEATHER_KEY is missing!")

          LAT, LON = 51.5308, -0.1238
          url = f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric"

          r = requests.get(url)
          print("HTTP status:", r.status_code)
          print("Response:", r.text)

          data = r.json()
          if "main" not in data:
              raise Exception(f"‚ùå OpenWeather API error: {data}")

          weather_info = {
              "temperature_C": data["main"]["temp"],
              "windspeed_kmh": data["wind"]["speed"],
              "weather_code": data["weather"][0]["id"]
          }

          # --- TFL DATA ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_url = f"https://api.tfl.gov.ukd + web page [skip ci]" || echo "No changes to commit"
          git push origin main
