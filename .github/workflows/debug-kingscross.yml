name: Debug KingsCross Workflow

on:
  workflow_dispatch:

jobs:
  debug:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout repository (full)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Print runner info
        run: |
          echo "Runner: $RUNNER_OS"
          echo "Python location: $pythonLocation"
          uname -a || true
          echo "Current dir: $(pwd)"
          echo "Home: $HOME"
          echo "Listing top-level files:"
          ls -la

      - name: Show scripts folder and file list
        run: |
          echo ">>> Listing scripts directory"
          ls -la scripts || true
          echo ">>> Showing a quick head of each script (if exists)"
          for f in scripts/*.py; do
            echo "---- $f ----"
            sed -n '1,120p' "$f" || true
            echo ""
          done || true

      - name: Print important env (masked)
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
          GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
          NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          echo "Listing keys presence (values hidden)"
          [ -z "$OPENWEATHER_KEY" ] && echo "OPENWEATHER_KEY = MISSING" || echo "OPENWEATHER_KEY = PRESENT"
          [ -z "$TFL_APP_KEY" ] && echo "TFL_APP_KEY = MISSING" || echo "TFL_APP_KEY = PRESENT"
          [ -z "$EVENTBRITE_TOKEN" ] && echo "EVENTBRITE_TOKEN = MISSING" || echo "EVENTBRITE_TOKEN = PRESENT"
          [ -z "$GOOGLE_PLACES_KEY" ] && echo "GOOGLE_PLACES_KEY = MISSING" || echo "GOOGLE_PLACES_KEY = PRESENT"
          [ -z "$NEWS_API_KEY" ] && echo "NEWS_API_KEY = MISSING" || echo "NEWS_API_KEY = PRESENT"
          [ -z "$OPENAI_API_KEY" ] && echo "OPENAI_API_KEY = MISSING" || echo "OPENAI_API_KEY = PRESENT"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install minimal deps (for run)
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Create logs dir
        run: mkdir -p logs

      - name: Run fetch_weather.py (capture logs)
        run: |
          if [ -f scripts/fetch_weather.py ]; then
            echo "Running fetch_weather.py..."
            python scripts/fetch_weather.py > logs/fetch_weather.stdout 2> logs/fetch_weather.stderr || echo "weather exited $?" > logs/fetch_weather.exit
          else
            echo "NO_FILE" > logs/fetch_weather.stderr
          fi

      - name: Run fetch_tfl.py (capture logs)
        run: |
          if [ -f scripts/fetch_tfl.py ]; then
            echo "Running fetch_tfl.py..."
            python scripts/fetch_tfl.py > logs/fetch_tfl.stdout 2> logs/fetch_tfl.stderr || echo "tfl exited $?" > logs/fetch_tfl.exit
          else
            echo "NO_FILE" > logs/fetch_tfl.stderr
          fi

      - name: Run fetch_places_reviews.py (capture logs)
        run: |
          if [ -f scripts/fetch_places_reviews.py ]; then
            echo "Running fetch_places_reviews.py..."
            python scripts/fetch_places_reviews.py > logs/fetch_places_reviews.stdout 2> logs/fetch_places_reviews.stderr || echo "places exited $?" > logs/fetch_places_reviews.exit
          else
            echo "NO_FILE" > logs/fetch_places_reviews.stderr
          fi

      - name: Run fetch_events.py (capture logs)
        run: |
          if [ -f scripts/fetch_events.py ]; then
            echo "Running fetch_events.py..."
            python scripts/fetch_events.py > logs/fetch_events.stdout 2> logs/fetch_events.stderr || echo "events exited $?" > logs/fetch_events.exit
          else
            echo "NO_FILE" > logs/fetch_events.stderr
          fi

      - name: Run fetch_news.py (capture logs)
        run: |
          if [ -f scripts/fetch_news.py ]; then
            echo "Running fetch_news.py..."
            python scripts/fetch_news.py > logs/fetch_news.stdout 2> logs/fetch_news.stderr || echo "news exited $?" > logs/fetch_news.exit
          else
            echo "NO_FILE" > logs/fetch_news.stderr
          fi

      - name: Show data folder contents
        run: |
          echo ">>> data folder:"
          ls -la data || true
          find data -maxdepth 2 -type f -print || true

      - name: Upload logs artifact
        uses: actions/upload-artifact@v4
        with:
          name: debug-logs
          path: logs