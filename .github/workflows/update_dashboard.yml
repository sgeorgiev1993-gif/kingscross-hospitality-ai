name: Update Kings Cross Dashboard

on:
  schedule:
    - cron: "0 * * * *"
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
      TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # ----------------------------
      # BUILD DASHBOARD + HISTORY
      # ----------------------------
      - name: Build dashboard & history
        run: |
          python - <<'PY'
import os, json, datetime, requests, statistics

LAT, LON = 51.5308, -0.1238
OPENWEATHER_KEY = os.getenv("OPENWEATHER_KEY")
TFL_APP_KEY = os.getenv("TFL_APP_KEY")
EVENTBRITE_TOKEN = os.getenv("EVENTBRITE_TOKEN")

os.makedirs("data/history", exist_ok=True)

dashboard = {
    "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
    "weather": {},
    "tfl": [],
    "events": []
}

# WEATHER
if OPENWEATHER_KEY:
    try:
        w = requests.get(
            "https://api.openweathermap.org/data/2.5/weather",
            params={"lat": LAT, "lon": LON, "appid": OPENWEATHER_KEY, "units": "metric"},
            timeout=10
        ).json()
        dashboard["weather"] = {
            "temperature_C": w["main"]["temp"],
            "windspeed_kmh": w["wind"]["speed"],
            "condition": w["weather"][0]["main"]
        }
    except:
        pass

# TFL
if TFL_APP_KEY:
    try:
        r = requests.get(
            "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr/Status",
            params={"app_key": TFL_APP_KEY},
            timeout=10
        ).json()
        for line in r:
            dashboard["tfl"].append({
                "name": line["name"],
                "mode": line["modeName"],
                "status": line["lineStatuses"][0]["statusSeverityDescription"]
            })
    except:
        pass

# EVENTS
if EVENTBRITE_TOKEN:
    try:
        r = requests.get(
            "https://www.eventbriteapi.com/v3/events/search/",
            headers={"Authorization": f"Bearer {EVENTBRITE_TOKEN}"},
            params={"location.address": "Kings Cross London", "location.within": "1km"},
            timeout=10
        ).json()
        for e in r.get("events", [])[:5]:
            dashboard["events"].append({
                "name": e["name"]["text"],
                "start": e["start"]["utc"],
                "url": e["url"]
            })
    except:
        pass

json.dump(dashboard, open("data/kingscross_dashboard.json","w"), indent=2)

# HISTORY
hist_file="data/history/kingscross_history.json"
history=[]
if os.path.exists(hist_file):
    history=json.load(open(hist_file))

temp=dashboard.get("weather",{}).get("temperature_C",10)
stress=sum(1 for l in dashboard["tfl"] if l["status"]!="Good Service")*8
events=len(dashboard["events"])*6
busyness=min(40+(10 if temp>15 else 0)+stress+events,100)

history.append({
    "timestamp": dashboard["timestamp"],
    "busyness": busyness
})
history=history[-300:]
json.dump(history,open(hist_file,"w"),indent=2)

# FORECAST (WITH RUSH HOUR)
values=[h["busyness"] for h in history] or [50]
avg=sum(values)/len(values)
std=statistics.pstdev(values) if len(values)>1 else 8

forecast=[]
now=datetime.datetime.utcnow()
for i in range(1,13):
    t=now+datetime.timedelta(hours=i)
    rush=t.hour in (7,8,9,16,17,18)
    base=avg+(12 if rush else 0)
    forecast.append({
        "time": t.isoformat()+"Z",
        "busyness": int(min(base,100)),
        "low": int(max(base-std,0)),
        "high": int(min(base+std,100)),
        "rush_hour": rush,
        "confidence": "low" if len(values)<6 else "medium"
    })

json.dump(forecast,open("data/forecast.json","w"),indent=2)
print("✅ Dashboard, history, forecast created")
PY
# -------------------------
      # EVENT-AWARE FORECAST BOOST
      # -------------------------
      - name: Apply event-aware forecast boost
        run: |
          python - <<'PY'
import json, os, datetime

FORECAST = "data/forecast.json"
DASH     = "data/kingscross_dashboard.json"

if not os.path.exists(FORECAST) or not os.path.exists(DASH):
    print("Missing files, skipping event boost")
    raise SystemExit(0)

forecast = json.load(open(FORECAST))
dashboard = json.load(open(DASH))
events = dashboard.get("events", [])

for f in forecast:
    ft = datetime.datetime.fromisoformat(f["time"].replace("Z",""))
    f["event_boost"] = 0
    f["reason"] = f.get("reason","baseline")

    for e in events:
        try:
            et = datetime.datetime.fromisoformat(e["start"].replace("Z",""))
        except:
            continue

        # Event within ±2 hours
        if abs((ft - et).total_seconds()) <= 2 * 3600:
            f["event_boost"] = 10
            f["busyness"] = min(f["busyness"] + 10, 100)
            f["reason"] = "Event nearby"

json.dump(forecast, open(FORECAST, "w"), indent=2)
print("✅ Event-aware forecast applied")
PY

      # ----------------------------
      # COMMIT DATA
      # ----------------------------
      - name: Commit data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add data
          git commit -m "auto: update dashboard data" || echo "No changes"
          git push || true
