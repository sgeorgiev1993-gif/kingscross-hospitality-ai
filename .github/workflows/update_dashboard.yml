name: Update Kings Cross Dashboard

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # -------------------------
      # BUILD DASHBOARD + HISTORY + FORECAST
      # -------------------------
      - name: Build dashboard data
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'PY'
import os, json, datetime, requests

LAT, LON = 51.5308, -0.1238  # Kings Cross

OPENWEATHER_KEY = os.getenv("OPENWEATHER_KEY")
TFL_APP_KEY = os.getenv("TFL_APP_KEY")
EVENTBRITE_TOKEN = os.getenv("EVENTBRITE_TOKEN")

os.makedirs("data/history", exist_ok=True)

dashboard = {
    "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
    "weather": {},
    "tfl": {},
    "events": []
}

# ---------------- WEATHER ----------------
if OPENWEATHER_KEY:
    try:
        w = requests.get(
            "https://api.openweathermap.org/data/2.5/weather",
            params={
                "lat": LAT,
                "lon": LON,
                "appid": OPENWEATHER_KEY,
                "units": "metric"
            },
            timeout=10
        ).json()

        dashboard["weather"] = {
            "temperature_C": round(w["main"]["temp"], 1),
            "windspeed_kmh": round(w["wind"]["speed"] * 3.6, 1),
            "condition": w["weather"][0]["main"]
        }
    except Exception as e:
        print("Weather error:", e)

# ---------------- TFL ----------------
if TFL_APP_KEY:
    try:
        r = requests.get(
            "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr/Status",
            params={"app_key": TFL_APP_KEY},
            timeout=10
        ).json()

        for line in r:
            dashboard["tfl"][line["name"]] = {
                "mode": line["modeName"],
                "status": line["lineStatuses"][0]["statusSeverityDescription"]
            }
    except Exception as e:
        print("TfL error:", e)

# ---------------- EVENTS ----------------
if EVENTBRITE_TOKEN:
    try:
        r = requests.get(
            "https://www.eventbriteapi.com/v3/events/search/",
            headers={"Authorization": f"Bearer {EVENTBRITE_TOKEN}"},
            params={
                "location.address": "Kings Cross London",
                "location.within": "1km",
                "expand": "venue"
            },
            timeout=10
        ).json()

        for e in r.get("events", [])[:5]:
            dashboard["events"].append({
                "name": e["name"]["text"],
                "url": e["url"],
                "start": e["start"]["utc"]
            })
    except Exception as e:
        print("Eventbrite error:", e)

# ---------------- SAVE DASHBOARD ----------------
with open("data/kingscross_dashboard.json", "w") as f:
    json.dump(dashboard, f, indent=2)

# ---------------- HISTORY ----------------
hist_file = "data/history/signals_history.json"
history = []

if os.path.exists(hist_file):
    history = json.load(open(hist_file))

temp = dashboard.get("weather", {}).get("temperature_C", 0)
bad = ["Part Closure", "Severe Delays", "Reduced Service"]
transport_stress = sum(
    1 for l in dashboard["tfl"].values() if l["status"] in bad
) * 8

event_score = len(dashboard["events"]) * 6

busyness = min(
    40 + (10 if temp > 15 else 0) + transport_stress + event_score,
    100
)

history.append({
    "timestamp": dashboard["timestamp"],
    "busyness": busyness,
    "temperature": temp,
    "transport_stress": transport_stress,
    "events_count": len(dashboard["events"])
})

history = history[-300:]
json.dump(history, open(hist_file, "w"), indent=2)

# ---------------- FORECAST ----------------
forecast = []
now = datetime.datetime.utcnow()
recent = history[-6:] if len(history) >= 6 else history

avg = sum(h["busyness"] for h in recent) / len(recent) if recent else 50

for i in range(1, 13):
    forecast.append({
        "time": (now + datetime.timedelta(hours=i)).isoformat() + "Z",
        "busyness": min(int(avg), 100)
    })

json.dump(forecast, open("data/forecast.json", "w"), indent=2)

print("âœ… Dashboard, history, and forecast generated")
PY

      # -------------------------
      # COMMIT DATA
      # -------------------------
      - name: Commit data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add data
          git commit -m "auto: update dashboard data" || echo "No changes"
          git push || true
