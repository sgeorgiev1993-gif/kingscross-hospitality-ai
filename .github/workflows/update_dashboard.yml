- name: Build dashboard & history
        run: |
          python - <<'PY'
import os
import json
import datetime
import requests

LAT, LON = 51.5308, -0.1238
OPENWEATHER_KEY = os.getenv("OPENWEATHER_KEY")
TFL_APP_KEY = os.getenv("TFL_APP_KEY")
EVENTBRITE_TOKEN = os.getenv("EVENTBRITE_TOKEN")

os.makedirs("data", exist_ok=True)

dashboard = {
    "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
    "weather": {},
    "tfl": [],
    "events": []
}

# WEATHER
if OPENWEATHER_KEY:
    try:
        w = requests.get(
            "https://api.openweathermap.org/data/2.5/weather",
            params={
                "lat": LAT,
                "lon": LON,
                "appid": OPENWEATHER_KEY,
                "units": "metric"
            },
            timeout=10
        ).json()
        dashboard["weather"] = {
            "temperature_C": w["main"]["temp"],
            "windspeed_kmh": w["wind"]["speed"],
            "condition": w["weather"][0]["main"]
        }
    except Exception as e:
        print("Weather error:", e)

# TFL
if TFL_APP_KEY:
    try:
        r = requests.get(
            "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr/Status",
            params={"app_key": TFL_APP_KEY},
            timeout=10
        ).json()
        for line in r:
            dashboard["tfl"].append({
                "name": line["name"],
                "mode": line["modeName"],
                "status": line["lineStatuses"][0]["statusSeverityDescription"]
            })
    except Exception as e:
        print("TfL error:", e)

# EVENTS
if EVENTBRITE_TOKEN:
    try:
        r = requests.get(
            "https://www.eventbriteapi.com/v3/events/search/",
            headers={"Authorization": f"Bearer {EVENTBRITE_TOKEN}"},
            params={
                "location.address": "Kings Cross London",
                "location.within": "1km"
            },
            timeout=10
        ).json()
        for e in r.get("events", [])[:5]:
            dashboard["events"].append({
                "name": e["name"]["text"],
                "url": e["url"],
                "start": e["start"]["utc"]
            })
    except Exception as e:
        print("Eventbrite error:", e)

with open("data/kingscross_dashboard.json", "w") as f:
    json.dump(dashboard, f, indent=2)

print("âœ… Dashboard built")
PY
