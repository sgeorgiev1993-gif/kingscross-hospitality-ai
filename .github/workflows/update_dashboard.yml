name: Update Kings Cross Dashboard

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: update-dashboard
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
      TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          persist-credentials: true

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Build dashboard + history + forecast
        run: |
          python - <<'PY'
          import os, json, datetime
          import requests

          DATA_DIR = "data"
          os.makedirs(DATA_DIR, exist_ok=True)

          DASH_FILE = os.path.join(DATA_DIR, "kingscross_dashboard.json")
          HIST_FILE = os.path.join(DATA_DIR, "kingscross_history.json")
          FORECAST_FILE = os.path.join(DATA_DIR, "forecast.json")

          OPENWEATHER_KEY = os.getenv("OPENWEATHER_KEY")
          TFL_APP_KEY = os.getenv("TFL_APP_KEY")
          EVENTBRITE_TOKEN = os.getenv("EVENTBRITE_TOKEN")

          LAT, LON = 51.5308, -0.1238  # Kings Cross

          def safe_json_load(path, default):
            try:
              if os.path.exists(path):
                with open(path, "r", encoding="utf-8") as f:
                  return json.load(f)
            except Exception:
              pass
            return default

          # Start from existing dashboard if present (so we don't wipe places/news)
          dashboard = safe_json_load(DASH_FILE, {})
          if not isinstance(dashboard, dict):
            dashboard = {}

          dashboard.setdefault("weather", {})
          dashboard.setdefault("tfl", {})
          dashboard.setdefault("events", [])
          dashboard.setdefault("places", dashboard.get("places", []))
          dashboard.setdefault("news", dashboard.get("news", []))

          # Timestamp
          now = datetime.datetime.utcnow()
          dashboard["timestamp"] = now.isoformat() + "Z"

          # ---------------- WEATHER ----------------
          weather = {}
          if OPENWEATHER_KEY:
            try:
              w = requests.get(
                "https://api.openweathermap.org/data/2.5/weather",
                params={"lat": LAT, "lon": LON, "appid": OPENWEATHER_KEY, "units": "metric"},
                timeout=15
              ).json()
              weather = {
                "temperature_C": w["main"]["temp"],
                "windspeed_kmh": w["wind"]["speed"],
                "condition": w["weather"][0]["main"]
              }
            except Exception as e:
              print("Weather fetch failed:", e)
          dashboard["weather"] = weather

          # ---------------- TFL ----------------
          # Store as dict (your repo already uses dict form a lot)
          tfl_dict = {}
          try:
            params = {}
            if TFL_APP_KEY:
              params["app_key"] = TFL_APP_KEY

            tfl = requests.get(
              "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,national-rail/Status",
              params=params,
              timeout=20
            ).json()

            if isinstance(tfl, list):
              for line in tfl:
                name = line.get("name")
                mode = line.get("modeName", "unknown")
                status = "Unknown"
                try:
                  status = line["lineStatuses"][0]["statusSeverityDescription"]
                except Exception:
                  pass
                if name:
                  tfl_dict[name] = {"mode": mode, "status": status}
          except Exception as e:
            print("TfL fetch failed:", e)
          dashboard["tfl"] = tfl_dict

          # ---------------- EVENTS (Eventbrite) ----------------
          events = []
          if EVENTBRITE_TOKEN:
            try:
              r = requests.get(
                "https://www.eventbriteapi.com/v3/events/search/",
                headers={"Authorization": f"Bearer {EVENTBRITE_TOKEN}"},
                params={
                  "location.address": "Kings Cross London",
                  "location.within": "1km",
                  "sort_by": "date"
                },
                timeout=20
              ).json()
              for e in (r.get("events") or [])[:8]:
                try:
                  events.append({
                    "name": e["name"]["text"],
                    "url": e["url"],
                    "start": (e.get("start") or {}).get("utc") or (e.get("start") or {}).get("local")
                  })
                except Exception:
                  continue
            except Exception as e:
              print("Eventbrite fetch failed:", e)
          dashboard["events"] = events

          # Save dashboard
          with open(DASH_FILE, "w", encoding="utf-8") as f:
            json.dump(dashboard, f, indent=2, ensure_ascii=False)
          print("✅ Wrote", DASH_FILE)

          # ---------------- HISTORY (append busyness) ----------------
          history = safe_json_load(HIST_FILE, [])
          if not isinstance(history, list):
            history = []

          # Signals -> busyness (simple baseline)
          temp = dashboard.get("weather", {}).get("temperature_C")
          if temp is None:
            temp = 0

          bad_statuses = {"Part Closure", "Severe Delays", "Reduced Service", "Planned Closure", "Service Closed"}
          tfl_items = list(dashboard.get("tfl", {}).values())
          transport_stress = sum(1 for x in tfl_items if (x.get("status") in bad_statuses)) * 8
          event_score = len(dashboard.get("events", [])) * 6
          temp_bonus = 10 if temp >= 15 else 0

          busyness = int(min(40 + temp_bonus + transport_stress + event_score, 100))

          history.append({
            "timestamp": dashboard["timestamp"],
            "busyness": busyness,
            "temperature_C": temp,
            "transport_stress": transport_stress,
            "events_count": len(dashboard.get("events", []))
          })

          # Keep last ~7 days hourly = 168; keep more for future ML
          history = history[-500:]

          with open(HIST_FILE, "w", encoding="utf-8") as f:
            json.dump(history, f, indent=2, ensure_ascii=False)
          print("✅ Wrote", HIST_FILE, "rows=", len(history))

          # ---------------- FORECAST (safe) ----------------
          recent = history[-6:] if len(history) >= 6 else history
          avg = (sum(h.get("busyness", 50) for h in recent) / len(recent)) if recent else 50

          forecast = []
          for i in range(1, 13):
            forecast.append({
              "time": (now + datetime.timedelta(hours=i)).isoformat() + "Z",
              "busyness": int(min(avg, 100))
            })

          with open(FORECAST_FILE, "w", encoding="utf-8") as f:
            json.dump(forecast, f, indent=2, ensure_ascii=False)
          print("✅ Wrote", FORECAST_FILE)
          PY

      - name: Commit & push updated data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add data/kingscross_dashboard.json data/kingscross_history.json data/forecast.json
          git commit -m "auto: update dashboard, history, forecast" || echo "No changes"
          git push
