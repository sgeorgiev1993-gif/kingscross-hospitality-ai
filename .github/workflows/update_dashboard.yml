name: Update Kings Cross Dashboard

on:
  schedule:
    - cron: "0 * * * *"   # every hour
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest

    env:
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
      TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests

      # --------------------------------------------------
      # BUILD DASHBOARD + HISTORY
      # --------------------------------------------------
      - name: Build dashboard and history
        run: |
          python <<'PY'
          import os, json, datetime, requests

          LAT, LON = 51.5308, -0.1238
          OPENWEATHER_KEY = os.getenv("OPENWEATHER_KEY")
          TFL_APP_KEY = os.getenv("TFL_APP_KEY")
          EVENTBRITE_TOKEN = os.getenv("EVENTBRITE_TOKEN")

          os.makedirs("data/history", exist_ok=True)

          dashboard = {
              "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
              "weather": {},
              "tfl": [],
              "events": []
          }

          # -------- Weather --------
          if OPENWEATHER_KEY:
              try:
                  w = requests.get(
                      "https://api.openweathermap.org/data/2.5/weather",
                      params={
                          "lat": LAT,
                          "lon": LON,
                          "appid": OPENWEATHER_KEY,
                          "units": "metric"
                      },
                      timeout=10
                  ).json()

                  dashboard["weather"] = {
                      "temperature_C": w["main"]["temp"],
                      "windspeed_kmh": w["wind"]["speed"],
                      "condition": w["weather"][0]["main"]
                  }
              except Exception as e:
                  print("Weather error:", e)

          # -------- TfL --------
          if TFL_APP_KEY:
              try:
                  r = requests.get(
                      "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr/Status",
                      params={"app_key": TFL_APP_KEY},
                      timeout=10
                  ).json()

                  for line in r:
                      dashboard["tfl"].append({
                          "name": line["name"],
                          "mode": line["modeName"],
                          "status": line["lineStatuses"][0]["statusSeverityDescription"]
                      })
              except Exception as e:
                  print("TfL error:", e)

          # -------- Events --------
          if EVENTBRITE_TOKEN:
              try:
                  r = requests.get(
                      "https://www.eventbriteapi.com/v3/events/search/",
                      headers={"Authorization": f"Bearer {EVENTBRITE_TOKEN}"},
                      params={
                          "location.address": "Kings Cross London",
                          "location.within": "1km"
                      },
                      timeout=10
                  ).json()

                  for e in r.get("events", [])[:5]:
                      dashboard["events"].append({
                          "name": e["name"]["text"],
                          "url": e["url"],
                          "start": e["start"]["utc"]
                      })
              except Exception as e:
                  print("Eventbrite error:", e)

          # -------- Save dashboard --------
          with open("data/kingscross_dashboard.json", "w") as f:
              json.dump(dashboard, f, indent=2)

          # -------- History --------
          hist_file = "data/history/signals_history.json"
          history = []

          if os.path.exists(hist_file):
              history = json.load(open(hist_file))

          temp = dashboard.get("weather", {}).get("temperature_C", 0)
          bad = ["Part Closure", "Severe Delays", "Reduced Service"]
          transport_stress = sum(
              1 for l in dashboard["tfl"] if l["status"] in bad
          ) * 8

          event_score = len(dashboard["events"]) * 6

          busyness = min(
              40 + (10 if temp > 15 else 0) + transport_stress + event_score,
              100
          )

          history.append({
              "timestamp": dashboard["timestamp"],
              "busyness": busyness,
              "temperature": temp,
              "transport_stress": transport_stress,
              "events_count": len(dashboard["events"])
          })

          history = history[-300:]

          with open(hist_file, "w") as f:
              json.dump(history, f, indent=2)

          print("✅ Dashboard & history generated")
          PY

    # --------------------------------------------------
      # FORECAST (RUSH-HOUR AWARE + CONFIDENCE)
      # --------------------------------------------------
      - name: Generate rush-hour aware forecast
        run: |
          python <<'PY'
          import json, datetime, os, statistics
          from zoneinfo import ZoneInfo

          HIST = "data/history/signals_history.json"
          OUT  = "data/forecast.json"

          history = []
          if os.path.exists(HIST):
              history = json.load(open(HIST))

          values = [h.get("busyness", 50) for h in history if isinstance(h, dict)]
          if not values:
              values = [50]

          avg = sum(values) / len(values)
          std = statistics.pstdev(values) if len(values) > 1 else 8

          tz = ZoneInfo("Europe/London")
          now = datetime.datetime.now(tz)

          forecast = []

          for i in range(1, 13):
              t = now + datetime.timedelta(hours=i)
              hour = t.hour

              rush = (7 <= hour <= 10) or (16 <= hour <= 19)
              boost = 15 if rush and hour >= 16 else 12 if rush else 0

              base = min(avg + boost, 100)

              forecast.append({
                  "time": t.isoformat(),
                  "busyness": int(base),
                  "low": int(max(base - std, 0)),
                  "high": int(min(base + std, 100)),
                  "confidence": (
                      "low" if len(values) < 6 else
                      "medium" if len(values) < 24 else
                      "high"
                  ),
                  "rush_hour": rush
              })

          with open(OUT, "w") as f:
              json.dump(forecast, f, indent=2)

          print("✅ Rush-hour forecast generated")
          PY

      # --------------------------------------------------
      # COMMIT DATA
      # --------------------------------------------------
      - name: Commit data
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add data
          git commit -m "auto: update dashboard data" || echo "No changes"
          git push || true