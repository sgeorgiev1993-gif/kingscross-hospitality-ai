name: Update KingsCross Dashboard

on:
  schedule:
    - cron: '0 * * * *'       # hourly
    - cron: '30 3 * * 0'      # weekly model training (Sunday 03:30 UTC)
  workflow_dispatch:

jobs:
  update:
    runs-on: ubuntu-latest
    env:
      # Optional secrets - set these in GitHub if you have them
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
      TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
      GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Create data folders
        run: |
          mkdir -p data/raw
          mkdir -p data/processed
          mkdir -p data/predictions

      # -----------------------------
      # FETCH: run unified fetch_all script (fallback to old scripts if not present)
      # -----------------------------
      - name: Fetch all data (fetch_all.py preferred)
        run: |
          if [ -f scripts/fetch_all.py ]; then
            python scripts/fetch_all.py
          else
            # fallback: run existing fetch scripts if present
            [ -f scripts/fetch_weather.py ] && python scripts/fetch_weather.py || true
            [ -f scripts/fetch_tfl.py ] && python scripts/fetch_tfl.py || true
            [ -f scripts/fetch_events.py ] && python scripts/fetch_events.py || true
            [ -f scripts/fetch_eventbrite.py ] && python scripts/fetch_eventbrite.py || true
            [ -f scripts/fetch_places_reviews.py ] && python scripts/fetch_places_reviews.py || true
            [ -f scripts/fetch_news.py ] && python scripts/fetch_news.py || true
          fi

      # -----------------------------
      # PROCESS: normalize raw -> processed
      # -----------------------------
      - name: Process & clean data (build_dashboard)
        run: |
          if [ -f scripts/process/build_dashboard.py ]; then
            python scripts/process/build_dashboard.py
          elif [ -f scripts/generate_dashboard.py ]; then
            python scripts/generate_dashboard.py
          else
            echo "No dashboard builder found; skipping"
          fi

      # -----------------------------
      # ML: append history CSV + generate predictions
      # -----------------------------
      - name: Build ML features & predictions
        run: |
          if [ -f scripts/predict/predict_busyness.py ]; then
            python scripts/predict/predict_busyness.py
          else
            # fallback: a simple predictions generator (creates data/predictions/baseline.json)
            python - <<'PY'
import json, datetime, os
# Simple baseline prediction generator if no script exists
dashboard = {}
try:
    with open("data/dashboard.json") as f:
        dashboard = json.load(f)
except:
    try:
        with open("data/kingscross_dashboard.json") as f:
            dashboard = json.load(f)
    except:
        dashboard = {}
pred = {
  "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
  "crowd_score": 50,
  "restaurant_load_pct": 50,
  "transport_stress_pct": 10,
  "weather_impact": "Low",
  "events_impact": "Low",
  "note": "baseline placeholder"
}
os.makedirs("data/predictions", exist_ok=True)
with open("data/predictions/baseline.json","w") as f:
    json.dump(pred,f,indent=2)
print("Wrote data/predictions/baseline.json")
PY
          fi

      # -----------------------------
      # Commit any updated data back to repo
      # -----------------------------
      - name: Commit data updates
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add data || true
          git commit -m "chore: update data and predictions [ci skip]" || echo "No changes to commit"
          git push || echo "Push failed (maybe no permission)"

  train_model:
    runs-on: ubuntu-latest
    needs: update
    if: github.event_name == 'schedule' && contains(github.event.schedule || '', '30 3 * * 0') || github.event_name == 'workflow_dispatch'
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          if [ -f requirements.txt ]; then pip install -r requirements.txt; fi

      - name: Train ML model (if present)
        run: |
          if [ -f scripts/predict/train_model.py ]; then
            python scripts/predict/train_model.py
          else
            echo "No training script found; skipping"
          fi
