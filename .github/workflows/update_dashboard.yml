name: Full KingsCross Dashboard

on:
  schedule:
    - cron: '0 * * * *'        # Hourly updates
    - cron: '30 3 * * 0'       # Sunday 03:30 weekly ML training
  workflow_dispatch:

jobs:

  update:
    runs-on: ubuntu-latest

    env:
      OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
      TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
      EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
      GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
      NEWS_API_KEY: ${{ secrets.NEWS_API_KEY }}

    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python 3.11
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r Files/requirements.txt

      - name: Ensure data folders exist
        run: |
          mkdir -p Files/data/raw
          mkdir -p Files/data/processed
          mkdir -p Files/data/predictions

      # -----------------------------
      # FETCH SOURCES
      # -----------------------------
      - name: Fetch all data
        run: |
          # WEATHER
          [ -f Files/scripts/fetch/fetch_weather.py ] \
            && python Files/scripts/fetch/fetch_weather.py \
            || echo "Missing fetch_weather.py"

          # TFL
          [ -f Files/scripts/fetch/fetch_tfl.py ] \
            && python Files/scripts/fetch/fetch_tfl.py \
            || echo "Missing fetch_tfl.py"

          # EVENTBRITE
          [ -f Files/scripts/fetch/fetch_eventbrite.py ] \
            && python Files/scripts/fetch/fetch_eventbrite.py \
            || echo "Missing fetch_eventbrite.py"

          # NEWS
          [ -f Files/scripts/fetch/fetch_news.py ] \
            && python Files/scripts/fetch/fetch_news.py \
            || echo "Missing fetch_news.py"

          # PLACES
          [ -f Files/scripts/fetch/fetch_places_reviews.py ] \
            && python Files/scripts/fetch/fetch_places_reviews.py \
            || echo "Missing fetch_places_reviews.py"

      # -----------------------------
      # BUILD MAIN DASHBOARD JSON
      # -----------------------------
      - name: Build dashboard
        run: |
          if [ -f Files/scripts/process/build_dashboard.py ]; then
            python Files/scripts/process/build_dashboard.py
          else
            echo "Missing build_dashboard.py"
          fi

      # -----------------------------
      # ML PREDICTIONS
      # -----------------------------
      - name: Run ML predictions
        run: |
          if [ -f Files/scripts/predict/predict_busyness.py ]; then
            python Files/scripts/predict/predict_busyness.py
          else
            echo "Predict script missing â€” fallback used"

            python - <<'PY'
import os, json, datetime
os.makedirs("Files/data/predictions", exist_ok=True)
pred = {
  "timestamp": datetime.datetime.utcnow().isoformat() + "Z",
  "crowd_score": 50,
  "restaurant_load_pct": 50,
  "transport_stress_pct": 10,
  "weather_impact": "Low",
  "events_impact": "Low",
  "note": "fallback baseline"
}
with open("Files/data/predictions/baseline.json","w") as f:
    json.dump(pred, f, indent=2)
PY

      # -----------------------------
      # COMMIT UPDATED DATA
      # -----------------------------
      - name: Commit results
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "actions@github.com"
          git add Files/data || true
          git commit -m "Auto-update dashboard & predictions" || echo "No changes"
          git push

  train_model:
    runs-on: ubuntu-latest
    needs: update
    if: github.event_name == 'schedule' && contains(github.event.schedule, '30 3 * * 0')
    steps:

      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r Files/requirements.txt

      - name: Train ML model
        run: |
          if [ -f Files/scripts/predict/train_model.py ]; then
            python Files/scripts/predict/train_model.py
          else
            echo "No train_model.py found"
          fi
