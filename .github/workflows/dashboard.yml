name: ğŸŒ Kings Cross Live Dashboard

on:
  schedule:
    - cron: "0 */6 * * *" # Runs every 6 hours
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: ğŸ“¦ Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: ğŸ“¥ Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install requests pandas matplotlib

      - name: ğŸ—‚ï¸ Prepare folders
        run: |
          mkdir -p dashboard_build/data
          mkdir -p data

      - name: ğŸš‡ Fetch TfL (Transport for London) data
        run: |
          python - <<'EOF'
          import requests, json, os

          url = "https://api.tfl.gov.uk/Line/Mode/tube,overground,dlr,tram,elizabeth-line,national-rail/Status"
          try:
              res = requests.get(url, timeout=10)
              res.raise_for_status()
              data = res.json()
          except Exception as e:
              print("âš ï¸ Error fetching TfL data:", e)
              data = []

          summary = []
          if isinstance(data, list):
              for line in data:
                  name = line.get("name", "Unknown")
                  statuses = [s.get("statusSeverityDescription", "Unknown") for s in line.get("lineStatuses", [])]
                  summary.append({"line": name, "status": ", ".join(statuses)})
          else:
              print("âš ï¸ Unexpected data format from TfL")

          os.makedirs("dashboard_build/data", exist_ok=True)
          with open("dashboard_build/data/tfl_status.json", "w") as f:
              json.dump(summary, f, indent=2)
          EOF

      - name: ğŸŒ¦ï¸ Fetch Weather Data (OpenWeather)
        env:
          WEATHER_API_KEY: ${{ secrets.WEATHER_API_KEY }}
        run: |
          python - <<'EOF'
          import requests, json, os
          key = os.getenv("WEATHER_API_KEY")
          if not key:
              print("âš ï¸ Missing WEATHER_API_KEY secret, skipping weather")
              weather = {}
          else:
              try:
                  url = f"https://api.openweathermap.org/data/2.5/weather?q=London,uk&appid={key}&units=metric"
                  res = requests.get(url, timeout=10)
                  res.raise_for_status()
                  weather = res.json()
              except Exception as e:
                  print("âš ï¸ Weather fetch failed:", e)
                  weather = {}

          os.makedirs("dashboard_build/data", exist_ok=True)
          with open("dashboard_build/data/weather.json", "w") as f:
              json.dump(weather, f, indent=2)
          EOF

      - name: ğŸ« Fetch Eventbrite Events
        env:
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'EOF'
          import requests, json, os

          token = os.getenv("EVENTBRITE_TOKEN")
          if not token:
              print("âš ï¸ Missing EVENTBRITE_TOKEN secret, skipping events")
              events = []
          else:
              try:
                  url = "https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&expand=venue"
                  headers = {"Authorization": f"Bearer {token}"}
                  res = requests.get(url, headers=headers, timeout=10)
                  res.raise_for_status()
                  data = res.json()
                  events = []
                  for ev in data.get("events", []):
                      events.append({
                          "name": ev.get("name", {}).get("text", "Unnamed event"),
                          "start": ev.get("start", {}).get("local"),
                          "end": ev.get("end", {}).get("local"),
                          "url": ev.get("url"),
                          "venue": ev.get("venue", {}).get("name")
                      })
              except Exception as e:
                  print("âš ï¸ Eventbrite fetch failed:", e)
                  events = []

          os.makedirs("dashboard_build/data", exist_ok=True)
          with open("dashboard_build/data/events.json", "w") as f:
              json.dump(events, f, indent=2)
          EOF

      - name: ğŸ§  Combine all data into dashboard
        run: |
          python - <<'EOF'
          import json, datetime, os

          def load(path):
              if os.path.exists(path):
                  with open(path) as f:
                      return json.load(f)
              return {}

          data = {
              "updated": datetime.datetime.utcnow().isoformat(),
              "tfl": load("dashboard_build/data/tfl_status.json"),
              "weather": load("dashboard_build/data/weather.json"),
              "events": load("dashboard_build/data/events.json"),
          }

          os.makedirs("dashboard_build/data", exist_ok=True)
          with open("dashboard_build/data/kingscross_dashboard.json", "w") as f:
              json.dump(data, f, indent=2)
          EOF

      - name: ğŸ—‚ï¸ Prepare deployment
        run: |
          cp index.html dashboard_build/ || echo "âš ï¸ index.html missing, skipping copy"
          cp -r data dashboard_build/data || true

      - name: ğŸš€ Deploy to gh-pages
        run: |
          git fetch origin gh-pages || true
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git checkout gh-pages || git checkout -b gh-pages
          git pull origin gh-pages --rebase || true
          cp -r dashboard_build/* .
          git add .
          git commit -m "ğŸŒ Auto-update dashboard (TfL + Weather + Events)" || echo "No changes to commit"
          git push origin gh-pages || echo "Push skipped (no changes or conflict)"