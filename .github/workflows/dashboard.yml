name: üèôÔ∏è Kings Cross Dashboard

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *"  # every hour

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: Install dependencies
        run: |
          pip install requests matplotlib pandas

      - name: Fetch data & generate dashboard
        env:
          OPENWEATHER_KEY: ${{ secrets.OPENWEATHER_KEY }}
          TFL_APP_KEY: ${{ secrets.TFL_APP_KEY }}
          EVENTBRITE_TOKEN: ${{ secrets.EVENTBRITE_TOKEN }}
        run: |
          python - <<'EOF'
          import os, json, datetime, pathlib, requests, matplotlib.pyplot as plt, pandas as pd

          pathlib.Path("data").mkdir(exist_ok=True)

          # --- WEATHER DATA ---
          API_KEY = os.getenv("OPENWEATHER_KEY")
          if not API_KEY: raise Exception("OPENWEATHER_KEY missing")
          LAT, LON = 51.5308, -0.1238
          r = requests.get(f"https://api.openweathermap.org/data/2.5/weather?lat={LAT}&lon={LON}&appid={API_KEY}&units=metric")
          data = r.json()
          if "main" not in data: raise Exception(f"OpenWeather API error: {data}")
          weather_info = {"temperature_C": data["main"]["temp"], "windspeed_kmh": data["wind"]["speed"], "weather_code": data["weather"][0]["id"]}

          # --- TfL DATA ---
          tfl_key = os.getenv("TFL_APP_KEY")
          tfl_r = requests.get(f"https://api.tfl.gov.uk/Line/Mode/all/Status?app_key={tfl_key}")
          tfl_data = tfl_r.json()
          kings_cross_lines = {"Northern","Piccadilly","Victoria","Circle","Hammersmith & City","Metropolitan"}
          tfl_filtered = [{"name": l["name"], "mode": l["modeName"], "status": l.get("lineStatuses",[{}])[0].get("statusSeverityDescription","Unknown")} for l in tfl_data if l["name"] in kings_cross_lines]

          with open("data/kingscross_tfl.json","w") as f:
              json.dump(tfl_filtered, f, indent=2)

          # --- EVENTBRITE DATA ---
          EB_TOKEN = os.getenv("EVENTBRITE_TOKEN")
          if not EB_TOKEN: raise Exception("EVENTBRITE_TOKEN missing")
          eb_url = f"https://www.eventbriteapi.com/v3/events/search/?location.address=Kings+Cross+London&token={EB_TOKEN}&sort_by=date"
          eb_r = requests.get(eb_url)
          eb_data = eb_r.json()
          events = [{"name": e["name"]["text"], "start": e["start"]["local"], "url": e["url"]} for e in eb_data.get("events",[])]
          with open("data/events.json","w") as f:
              json.dump(events, f, indent=2)

          # --- DASHBOARD JSON ---
          dashboard = {"timestamp": datetime.datetime.utcnow().isoformat()+"Z", "weather": weather_info, "tfl": tfl_filtered, "events": events}
          with open("data/kingscross_dashboard.json","w") as f:
              json.dump(dashboard, f, indent=2)

          # --- DASHBOARD IMAGE ---
          fig, ax = plt.subplots(figsize=(10,5))
          temps = [dashboard["weather"]["temperature_C"]]
          ax.bar(["Temp (¬∞C)"], temps, color="blue")
          ax.set_title("Kings Cross Current Temperature")
          plt.tight_layout()
          plt.savefig("data/kingscross_dashboard.png")
          plt.close(fig)
          EOF

      - name: Deploy to GitHub Pages
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          # Use force copy to avoid overwrite issues
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout --orphan gh-pages

          cp -r data/* .
          [ -f index.html ] || cp ../index.html .

          git add -A
          git commit -m "üöÄ Update dashboard [skip ci]" || echo "No changes to commit"
          git push origin gh-pages --force