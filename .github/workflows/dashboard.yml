name: ðŸ§  Kings Cross Dashboard Auto Update

on:
  schedule:
    - cron: "0 */6 * * *" # Every 6 hours
  workflow_dispatch:

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          pip install requests pandas

      - name: Fetch data and update dashboard
        run: |
          mkdir -p data
          mkdir -p dashboard_build/data

          python - <<'EOF'
          import json, os, requests, datetime

          DASH_PATH = "data/kingscross_dashboard.json"
          HIST_PATH = "data/kingscross_history.json"

          # ---------- 1. Load previous history ----------
          history = {}
          if os.path.exists(HIST_PATH):
              try:
                  with open(HIST_PATH, "r") as f:
                      history = json.load(f)
              except:
                  history = {}

          tfl_hist = history.get("tfl_history", {})

          # ---------- 2. Fetch TFL data ----------
          print("Fetching TfL line status...")
          tfl_url = "https://api.tfl.gov.uk/line/mode/tube,overground,dlr,elizabeth-line/status"
          tfl_data = requests.get(tfl_url).json()

          today = str(datetime.date.today())
          status_summary = []
          for line in tfl_data:
              name = line.get("name")
              status = line["lineStatuses"][0]["statusSeverityDescription"]
              status_summary.append({"line": name, "status": status})

              # Count problems (0 = good, 1 = disrupted)
              val = 0 if "Good" in status else 1
              if name not in tfl_hist:
                  tfl_hist[name] = {}
              tfl_hist[name][today] = val

          # ---------- 3. Fetch weather ----------
          print("Fetching weather data...")
          weather_url = "https://api.open-meteo.com/v1/forecast?latitude=51.5309&longitude=-0.1233&current_weather=true"
          w = requests.get(weather_url).json().get("current_weather", {})

          weather = {
              "main": {"temp": w.get("temperature"), "humidity": 70},
              "wind": {"speed": w.get("windspeed")},
              "weather": [{"description": "Clear"}]
          }

          # ---------- 4. Fetch sample events (from existing events.json) ----------
          print("Loading local events data...")
          events_path = "data/events.json"
          events = []
          if os.path.exists(events_path):
              try:
                  with open(events_path, "r") as f:
                      events = json.load(f)
              except:
                  pass

          # ---------- 5. Combine and Save ----------
          dashboard = {
              "updated": datetime.datetime.utcnow().isoformat() + "Z",
              "tfl": status_summary,
              "weather": weather,
              "events": events
          }

          with open(DASH_PATH, "w") as f:
              json.dump(dashboard, f, indent=2)

          with open(HIST_PATH, "w") as f:
              json.dump({"tfl_history": tfl_hist}, f, indent=2)

          print("âœ… Dashboard and history updated successfully!")
          EOF

      - name: Commit and push updates to gh-pages
        run: |
          git fetch origin gh-pages || true
          git checkout gh-pages || git checkout -b gh-pages

          cp -r data/* ./data/
          cp index.html ./index.html

          git add data/ index.html || true
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git commit -m "ðŸ§  Auto-update dashboard & TfL history" || echo "No changes to commit"
          git push origin gh-pages