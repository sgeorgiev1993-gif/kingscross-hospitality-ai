name: Upload & Merge ZIP Into Repo

on:
  workflow_dispatch:
    inputs:
      zip_name:
        description: "Name of the ZIP file you will upload"
        required: true
        default: "upload.zip"

jobs:
  merge_zip:
    runs-on: ubuntu-latest

    steps:
      # --------------------------------------------------------
      # 1. Checkout Repo
      # --------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # --------------------------------------------------------
      # 2. Download uploaded ZIP artifact
      # --------------------------------------------------------
      - name: Download artifact ZIP
        uses: actions/download-artifact@v4
        with:
          name: ${{ github.event.inputs.zip_name }}
          path: ./zip_download

      # --------------------------------------------------------
      # 3. Prepare folders safely
      # --------------------------------------------------------
      - name: Prepare extraction directory
        run: mkdir -p extracted_zip

      # --------------------------------------------------------
      # 4. Find ZIP file and unzip
      # --------------------------------------------------------
      - name: Extract uploaded ZIP
        run: |
          zipfile=$(ls zip_download/*.zip | head -n1)

          if [ -z "$zipfile" ]; then
            echo "‚ùå ERROR: No ZIP file found inside artifact."
            exit 1
          fi

          echo "Found ZIP: $zipfile"
          unzip -o "$zipfile" -d extracted_zip

      # --------------------------------------------------------
      # 5. Copy extracted files into repo root (merge)
      # --------------------------------------------------------
      - name: Merge extracted ZIP contents into repository
        run: |
          shopt -s dotglob
          cp -R extracted_zip/* .

      # --------------------------------------------------------
      # 6. Commit merged changes
      # --------------------------------------------------------
      - name: Commit merged changes
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"

          git add -A
          git commit -m "Merged uploaded ZIP into repository" || echo "No changes to commit"

      # --------------------------------------------------------
      # 7. Push changes
      # --------------------------------------------------------
      - name: Push changes back to GitHub
        run: |
          git push
