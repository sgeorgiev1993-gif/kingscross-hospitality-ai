name: ğŸŒ† KingsCross Live Dashboard (TfL + Weather + Venues + Events)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 * * * *" # hourly

jobs:
  update-dashboard:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ§© Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"

      - name: ğŸ“¦ Install dependencies
        run: |
          pip install requests pandas matplotlib Pillow

      # 1ï¸âƒ£ TfL data
      - name: ğŸš‡ Fetch TfL Status
        run: |
          python scripts/fetch_tfl.py

      # 2ï¸âƒ£ Weather data
      - name: ğŸŒ¤ Fetch Weather
        run: |
          python - <<'EOF'
          import requests, json
          from pathlib import Path
          lat, lon = 51.5309, -0.1236
          url = f"https://api.open-meteo.com/v1/forecast?latitude={lat}&longitude={lon}&current=temperature_2m,precipitation,weathercode&timezone=Europe/London"
          res = requests.get(url).json()
          Path("data").mkdir(exist_ok=True)
          Path("data/kingscross_weather.json").write_text(json.dumps(res, indent=2))
          print("âœ… Weather data fetched")
          EOF

      # 3ï¸âƒ£ Google Places data (requires GOOGLE_PLACES_KEY secret)
      - name: ğŸ· Fetch Nearby Venues (Restaurants, Bars, CafÃ©s)
        env:
          GOOGLE_PLACES_KEY: ${{ secrets.GOOGLE_PLACES_KEY }}
        run: |
          python - <<'EOF'
          import requests, json
          from pathlib import Path

          API_KEY = "${{ secrets.GOOGLE_PLACES_KEY }}"
          if not API_KEY:
              print("âš ï¸ No Google Places API key found in secrets.")
          else:
              lat, lon = 51.5309, -0.1236
              types = ["restaurant", "bar", "cafe"]
              venues = []

              for place_type in types:
                  url = f"https://maps.googleapis.com/maps/api/place/nearbysearch/json?location={lat},{lon}&radius=800&type={place_type}&key={API_KEY}"
                  resp = requests.get(url).json()
                  for place in resp.get("results", []):
                      venues.append({
                          "name": place.get("name"),
                          "type": place_type,
                          "rating": place.get("rating"),
                          "address": place.get("vicinity"),
                          "open_now": place.get("opening_hours", {}).get("open_now", None)
                      })

              Path("data").mkdir(exist_ok=True)
              Path("data/kingscross_venues.json").write_text(json.dumps(venues, indent=2))
              print(f"âœ… Saved {len(venues)} nearby venues")
          EOF

      # 4ï¸âƒ£ Example Local Events (can connect to Eventbrite API later)
      - name: ğŸ­ Fetch Local Events
        run: |
          python - <<'EOF'
          import json
          from datetime import datetime
          from pathlib import Path
          events = [
              {"title": "Live Music Night", "time": str(datetime.now()), "location": "Scala, Kingâ€™s Cross"},
              {"title": "Street Food Market", "time": str(datetime.now()), "location": "Coal Drops Yard"}
          ]
          Path("data").mkdir(exist_ok=True)
          Path("data/events.json").write_text(json.dumps(events, indent=2))
          print("âœ… Local events updated")
          EOF

      # 5ï¸âƒ£ Merge all into dashboard
      - name: ğŸ“Š Generate Dashboard JSON
        run: |
          python - <<'EOF'
          import json
          from pathlib import Path
          data_dir = Path("data")
          dashboard = {}

          for f in data_dir.glob("*.json"):
              try:
                  dashboard[f.stem] = json.loads(f.read_text())
              except Exception as e:
                  print(f"âš ï¸ Skipped {f}: {e}")

          out_path = data_dir / "kingscross_dashboard.json"
          out_path.write_text(json.dumps(dashboard, indent=2))
          print("âœ… Dashboard built at", out_path)
          EOF

      # 6ï¸âƒ£ Deploy to gh-pages
      - name: ğŸš€ Deploy to GitHub Pages
        run: |
          git config user.email "github-actions@github.com"
          git config user.name "github-actions"
          git fetch origin gh-pages || echo "No gh-pages branch yet"
          git checkout gh-pages || git checkout --orphan gh-pages
          cp -r data ./data || true
          cp index.html ./index.html || echo "No index.html found, skipping"
          git add data index.html || true
          git commit -m "ğŸš€ Auto-update KingsCross dashboard [skip ci]" || echo "No changes"
          git push origin gh-pages --force
